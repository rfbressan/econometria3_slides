---
title: "Econometria III"
subtitle: |
    | Questões - Causalidade e Variáveis Instrumentais
# author: "Rafael Bressan"
# date: "`r Sys.Date()`"
output: 
    # pdf:
    #     latex_engine: xelatex
    #     keep_tex: true
    #     includes: 
    #       in_header: exam_preamble.tex
    html: 
      theme: cosmo
bibliography: references.bib
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
knitr::opts_chunk$set(warning = FALSE)
knitr::opts_chunk$set(message = FALSE)
```

```{r loads}
library(ISLR2)
library(modelsummary)
library(kableExtra)
library(dplyr)
library(caret)
library(DiagrammeR)
library(DiagrammeRsvg)
```

```{r setup-modelsummary}
g_map <- c("nobs", "logLik")
```

# Causalidade

## Questão 1 (2,0 pontos)

Assinale **V**erdadeiro ou **F**also, com relação a Causalidade. Justifique as falsas:

- ($\phantom{X}$) A estrutura de resultados potenciais é uma estrutura estatística usada para estudar o efeito causal de uma intervenção.

Resposta: Verdadeiro

- ($\phantom{X}$) O problema fundamental da inferência causal é que só podemos observar um resultado potencial para cada unidade.

Resposta: Verdadeiro

- ($\phantom{X}$) O resultado contrafactual refere-se ao que teria acontecido a um indivíduo na ausência de uma intervenção.

Resposta: Falso


- ($\phantom{X}$) Um experimento aleatorizado (RCT) é um tipo de estudo observacional que pode ajudar a estabelecer a causalidade.

Resposta: Falso

- ($\phantom{X}$) O efeito do tratamento para uma unidade de observação é a diferença entre os resultados potenciais nas condições de tratamento e controle.

Resposta: Verdadeiro

- ($\phantom{X}$) Uma variável de confusão é uma variável que está relacionada tanto à atribuição do tratamento quanto aos resultados potenciais.

Resposta: Verdadeiro

- ($\phantom{X}$) DAGs são uma ferramenta gráfica usada para representar as relações causais entre variáveis em um sistema.

Resposta: Verdadeiro

- ($\phantom{X}$) Em um DAG, as setas entre as variáveis representam relacionamentos causais, onde o início da seta indica a causa e a ponta da seta indica o efeito.

Resposta: Verdadeiro

- ($\phantom{X}$) Um caminho _backdoor_ em um DAG é um caminho que conecta a exposição (tratamento) ao resultado por meio de variáveis que não fazem parte do caminho causal.

Resposta: Verdadeiro

- ($\phantom{X}$) Um colisor em um DAG é uma variável causada por duas ou mais outras variáveis em um caminho entre tratamento e resultado, e pode induzir associações espúrias entre essas variáveis.

Resposta: Verdadeiro

- ($\phantom{X}$) Em um DAG, as setas entre as variáveis representam correlação em vez de causalidade. 

Resposta: Falso

- ($\phantom{X}$) DAGs podem ser usados para provar causalidade entre variáveis. 

Resposta: Falso

## Questão 2 (2,0 pontos)

Considere o seguinte DAG e responda aos itens abaixo:

```{r dag}
# Create a new empty graph
dag <- create_graph() |> 
    # Add nodes to the graph
    add_node(label = "X") |> 
    add_node(label = "Z") |> 
    add_node(label = "M") |> 
    add_node(label = "W") |> 
    add_node(label = "Y") |> 
    # Add edges to the graph
    add_edge("X", "Y") |> 
    add_edge("X", "M") |> 
    add_edge("X", "Z") |> 
    add_edge("W", "X") |> 
    add_edge("W", "Y") |> 
    add_edge("Y", "Z") |> 
    add_edge("M", "Y")

# Set node attributes
# dag <- dag |> 
#     set_node_attrs("shape", "circle") |> 
#     set_node_attrs("style", "filled") |> 
#     set_node_attrs("fillcolor", "#9b9b9b") |> 
#     set_node_attrs("fontname", "helvetica") |> 
#     set_node_attrs("fontsize", 12) |> 
#     # Set edge attributes
#     set_edge_attrs("arrowhead", "normal") |> 
#     set_edge_attrs("arrowsize", 0.7) |> 
#     set_edge_attrs("color", "#555555") |> 
#     set_edge_attrs("penwidth", 2)

# Render the graph
render_graph(dag)

```

a) Considerando que deseja-se estimar o efeito causal de X em Y, então descreva quem são as variáveis de confusão, os mecanismos e os colisores.

b) Se desejamos o efeito total de X em Y, então devemos controlar para W somente. Explique porque.

c) Explique por que a variável Z não pode ser utilizada como instrumento de X para recuperar o efeito causal de X em Y.

# Variáveis Instrumentais

## Questão 1 (2,0 pontos)

Assinale **V**erdadeiro ou **F**also, com relação a Variáveis Instrumentais. Justifique as falsas:

- ($\phantom{X}$) Considere o modelo $y = \alpha + \beta x + u$, onde $x$ é uma covariável endógena. Se $z$ é um instrumento válido para $x$, deve ser que $z$ influencie $x$ e que também influencie $y$, independentemente de $x$.

- ($\phantom{X}$) Para calcular os erros padrão corretos para os coeficientes estimados através do MQ2E é altamente recomendado o uso das rotinas de estimativa do MQ2E disponíveis em pacotes estatísticos ao invés de produzir essas estimativas manualmente.

- ($\phantom{X}$) Quando todas as suposições de identificação são válidas, podemos confiar que o estimador de variáveis instrumentais (VI) será consistente.

- ($\phantom{X}$) Considere o modelo $y = \alpha + \beta x + u$, onde $x$ é uma covariável endógena e $z$ é um candidato a instrumento para $x$. Se houver correlação entre $z$ e $u$, mas for menor que a correlação entre $x$ e $u$, será sempre melhor usar a estimativa VI do que a estimativa OLS, porque VI deve ter menor viés.

- ($\phantom{X}$) Instrumentos fracos podem inflar os erros padrão produzidos por VI, mas não induzem viés de amostra finita.

- ($\phantom{X}$) A regra de bolso para verificar se há instrumentos fracos é a seguinte: para o caso de um único regressor endógeno, a estatística F de primeiro estágio deve ser significativa para indicar um instrumento forte.

- ($\phantom{X}$) A distinção entre variáveis endógenas e exógenas depende da distribuição das variáveis: quando são normalmente distribuídas, são exógenas, caso contrário são endógenas.

- ($\phantom{X}$) O estimador MQ2E é consistente e tem uma distribuição normal em grandes amostras.

- ($\phantom{X}$) Instrumentos fracos são um problema porque fazem com que os instrumentos não sejam exógenos.


## Solução

( F ) $z$ não pode influenciar $y$ diretamente pois fere a restrição de exclusão.

( V )

( V )

( F ) Nem sempre. A condição para MQO ser melhor (menos pior) que VI seria $\operatorname{corr}\left(x_{i}, u_{i}\right) < \frac{\operatorname{corr}\left(z_{i}, u_{i}\right)}{\operatorname{corr}\left(z_{i}, x_{i}\right)}$. E mesmo assim pode-se argumentar que uma troca de sinal é a pior coisa que pode existir em um estimador. Neste sentido, mesmo que a magnitude do viés de VI seja maior, ainda poderíamos preferi-lo se pelo menos esteja com o sinal correto.

( F ) Instrumentos fracos podem induzir viés em amostra finita pois, na amostra, não necessariamente $\sum_{i=1}^{N}\left(z_{i}-\bar{z}\right) u_{i}=0$

( F ) Não basta ser significativa.

( F ) A distinção entre variáveis endógenas e exógenas se faz pela covariância com o termo de erro. Exógena: $E[u|x]=0$.

( V ) 

( F ) Instrumento não faz regressor ser exógeno ou não. O problema de instrumentos fracos é que pode existir viés mesmo em grandes amostras.


## Questão 2 (4,0 pontos)

No artigo de @mattos2011, os autores examinam a relação entre emprego público e redistribuição de renda nos municípios brasileiros. Eles utilizam os requisitos estabelecidos pela **Lei de Responsabilidade Fiscal como instrumento** para a variação do emprego público entre os municípios.

A LRF estabelece limites máximos para dois grandes itens do orçamento público, um deles sendo as despesas com folha de pagamento, que não devem ultrapassar 60% da receita corrente líquida (RCL) do município. A LRF é uma variável _dummy_ que equivale a um para governos cujo gasto com folha de pagamento ultrapassou 60% da RCL em pelo menos um ano entre 1997 e 1999 e estava dentro dos limites impostos pela LRF em 2000. Essa variável é igual a zero para todos os demais municípios. 

Este artigo propõe investigar o efeito do emprego público na distribuição de renda nos municípios brasileiros. A variável dependente é a desigualdade de renda (incineq), enquanto que as variáveis independentes são emprego público (publicemp) e outros controles. A _dummy_ lrf1 servirá de instrumento para o emprego público.

$$\text{incineq}_i=\eta + \delta \text{publicemp}_i + \lambda\text{controls}_i + \varepsilon_i$$

a) Por que o emprego público pode estar correlacionado com o termo de erro $\varepsilon$? Qual o problema resultante? (1,0 ponto)

b) Você acha que a LRF é um bom instrumento para o nível de emprego público local? Cite os dois critérios que uma variável instrumental deve atender e defenda ou critique a LRF com base nestes critérios. (1,5 pontos)

Os resultados do primeiro estágio são apresentados abaixo:

```{r mattos2011-stage1, out.height="100%"}
knitr::include_graphics("Figs/mattos2011_stage1.png")
```

c) Com base nestes resultados, você imagina que LRF é um bom instrumento para publicemp? O que você faria de diferente nesta estimação de primeiro estágio? (1,5 pontos)

## Questão 3 (4,0 pontos)

Considere um modelo para a saúde de um indivíduo:

$$saude=\beta_0+\beta_1 idade+\beta_2 peso+\beta_3 altura+\beta_4 masculino+\beta_5 trabalho+\beta_6 exercicio+u_1$$

onde `saude` é alguma medida quantitativa da saúde da pessoa; `idade`, `peso`, `altura` e `masculino` são autoexplicativos; `trabalho` é horas semanais trabalhadas; e `exercicio` são as horas de exercício por semana.

a) Por que você poderia se preocupar com o fato de o exercício estar correlacionado com o termo de erro $u_1$? Que problema esta correlação provocaria no seu estimador de MQO?

b) Suponha que você possa coletar dados sobre duas variáveis adicionais, `distcasa` e `distrab`, as distâncias de casa e do trabalho até a academia mais próxima. Discuta se estas variáveis seriam bons instrumentos para `exercicio`. Quais as condições que elas devem atender? Explique em detalhes.

c) Agora suponha que `distcasa` e `distrab` não estejam de fato correlacionados com $u_1$, assim como todas as variáveis na equação acima, com exceção de `exercicio`. Escreva a forma reduzida para `exercicio`.

d) Como as hipóteses de identificação na parte b) pode ser testada?

\color{red}
## Solução

a) A correlação entre exercício e o termo de erro $u_1$ pode ocorrer se houver algum fator não observável que afete tanto a quantidade de exercício que uma pessoa faz quanto sua saúde. Por exemplo, se pessoas que têm uma tendência genética para serem mais saudáveis também tendem a ser mais ativas fisicamente.

Se exercício e $u_1$ estiverem correlacionados, o estimador de Mínimos Quadrados Ordinários (MQO) pode ser viesado e inconsistente. Isso ocorre porque o MQO assume que não há correlação entre as variáveis independentes e o termo de erro. Se houver correlação, o MQO não será capaz de separar os efeitos de exercício na saude daqueles que vêm do termo de erro $u_1$, o que levará a estimativas incorretas dos coeficientes.

Uma maneira de lidar com esse problema é usar uma variável instrumental que seja correlacionada com exercício, mas não com $u_1$. A variável instrumental ajudará a isolar o efeito causal de exercício na saude, permitindo que o MQO forneça estimativas consistentes e não viesadas dos coeficientes.

b) As variáveis `distcasa` e `distrab` podem ser boas candidatas para servir como variáveis instrumentais para `exercicio`. Isso ocorre porque elas são correlacionadas com este, mas não devem estar correlacionadas com o termo de erro $u_1$.

Para que as variáveis instrumentais sejam válidas, elas devem atender a algumas condições:

*Relevância*: As variáveis instrumentais devem estar correlacionadas com a variável endógena (`exercicio`), ou seja, elas devem afetar a variável endógena de alguma forma.

*Exclusão*: As variáveis instrumentais não devem afetar diretamente (ou por meio de algum outro mecanismo que não a variável endógena) a variável dependente. Isso significa que elas não devem aparecer na equação de regressão.

*Exogeneidade*: As variáveis instrumentais devem ser independentes do termo de erro $u_1$. Isso significa que elas não devem ser afetadas por fatores não observáveis que também afetem saude.

No caso das variáveis `distcasa` e `distrab`, a primeira condição parece ser satisfeita, pois a distância até a academia mais próxima pode afetar a quantidade de exercício que uma pessoa faz. A segunda condição também parece plausível, já que a distância até a academia não deve estar diretamente relacionada à saúde de uma pessoa, por exemplo. A terceira condição não é possível de avaliar empiricamente, pois envolve fatores não observáveis que afetam tanto a distância até a academia quanto a saude. A validade desta terceira hipótese deve ser feita através de teoria economica e arguição lógica.

A primeira condição para a validade das variáveis instrumentais pode ser testada empiricamente através do teste F em primeiro estágio.

O teste F em primeiro estágio avalia se as variáveis instrumentais realmente afetam a variável endógena de forma significativa. Uma regressão é estimada da variável endógena (exercicio) sobre as variáveis instrumentais (distcasa ou distrab), juntamente com outras variáveis exógenas incluídas na equação de regressão. Em seguida, um teste F de contribuição marginal dos instrumentos é realizado para avaliar se estes têm um efeito significativo na variável endógena.

Se o resultado do teste F for significativo, indica que as variáveis instrumentais são relevantes. No entanto, é importante ressaltar que o teste F em primeiro estágio por si só não é suficiente para garantir a validade das variáveis instrumentais. É necessário avaliar também as outras condições discutidas anteriormente.

c) Se distcasa e distrab não estiverem correlacionados com o termo de erro $u_1$, podemos utilizá-las como variáveis instrumentais para exercicio na estimação via MQ2E.

O primeiro estágio consiste em estimar a relação entre as variáveis instrumentais (distcasa e distrab) e a variável endógena (exercicio) juntamente com outras variáveis exógenas que afetam exercicio. A equação do primeiro estágio é:

$$exer_i=\delta_0+\delta_1 distcasa_i+\delta_2distrab_i+\delta_3idade_i+\delta_4peso_i+\delta_5altura_i+\delta_6masculino_i+\delta_7trabalho_i+v_i$$

Onde $v_i$ é o termo de erro, e $\delta_j$ são os coeficientes a serem estimados.

Em seguida, no segundo estágio, substituímos exercicio na equação original pela previsão obtida no primeiro estágio e estimamos a relação entre as outras variáveis exógenas e a variável dependente `saude`. A equação do segundo estágio é:

$$saude_i=\beta_0+\beta_1idade_i+\beta_2peso_i+\beta_3altura_i+\beta_4masculino_i+\beta_5trabalho_i+\beta_6\hat{exer}_i+\varepsilon_i$$

Onde $\hat{exer}_i$ é a previsão de exercicio obtida no primeiro estágio para o indivíduo i, e $varepsilon_i$ é o termo de erro.

Os coeficientes estimados no segundo estágio fornecem as estimativas consistentes dos parâmetros do modelo original. A estimação via MQ2E é especialmente útil quando a variável endógena é afetada por um erro de medida ou por outras fontes de endogeneidade, como no caso em que exercicio está correlacionado com o termo de erro $u_1$. 

\color{black}

## Questão 4

Considere um modelo de estimação através de regressão de variáveis instrumentais

$$y_i=\beta_0+\beta_1 x_i+\beta_2w_i+u_i$$
onde temos uma amostra independente das variáveis aleatórias Y, X, W e Z. Suponha que X é um regressor endógeno, equanto W é exógeno. Z é um instrumento válido para X.

Escolha a alternativa correta para cada uma das questões abaixo. 


3.1) A regra de bolso para verificar se há instrumentos fracos é a seguinte: para o caso de um único regressor endógeno,
 
a) um primeiro estágio F deve ser estatisticamente significativo para indicar um instrumento forte.
b) um primeiro estágio F > 1,96 indica que os instrumentos são fracos.
c) a estatística t em cada um dos instrumentos deve exceder pelo menos 1,64.
d) um primeiro estágio F < 10 indica que os instrumentos são fracos.
e) tudo o que precede
 
 
3.2) A distinção entre variáveis endógenas e exógenas é
 
a) que as variáveis exógenas são determinadas dentro do modelo e as variáveis endógenas são determinadas fora do modelo
b) dependente do tamanho da amostra: para n > 100, as variáveis endógenas tornam-se exógenas
c) depende da distribuição das variáveis: quando são normalmente distribuídas, são
exógenas, caso contrário são endógenas
d) se as variáveis estão ou não correlacionadas com o termo de erro $u$
e) tudo o que precede
 
 
3.3) Quando observadas todas as suas hipóteses, o estimador MQ2E é:
 
a) consistente e tem uma distribuição normal em grandes amostras.
b) imparcial
c) eficiente em pequenas amostras
d) F-distribuído.
e) tudo o que precede
 
 
3.4) Instrumentos fracos são um problema porque:
 
a) o estimador MQ2E pode não ser normalmente distribuído, mesmo em grandes amostras.
b) fazem com que os instrumentos não sejam exógenos.
c) o estimador MQ2E não pode ser calculado.
d) você não pode mais prever as variáveis endógenas no primeiro estágio.
e) tudo o que precede
 
 

3.6) Sejam $W$ as variáveis exógenas incluídas em uma função de regressão que também tem regressores endógenos $X$. As variáveis $W$ podem:
 
a) ser variáveis de controle
b) tem a propriedade $E(u_i|W_i) = 0$
c) fazer um instrumento exógeno para a sua regressão
d) não ser incluídas na regressão de primeiro estágio
e) tudo o que precede
 
 
3.7) A lógica das variáveis de controle em regressões de VI:
 
a) é similar a lógica das variáveis de controle no MQO
b) só se aplica no caso de erros homocedásticos no primeiro estágio do MQ2E
c) é substancialmente diferente da lógica das variáveis de controle no MQO, uma vez que existem duas etapas na estimativa
d) implica que o MQ2E é eficiente
e) tudo o que precede
 
 
3.8) Para que $W$ seja uma variável de controle efetiva na estimativa de VI, onde $Z$ é o instrumento, a seguinte condição deve valer
 
a) $E(u_i) = 0$
b) $E(u_i|Z_i, W_i) = E(u_i|W_i)$
c) $E(u_iu_j) \neq 0$
d) deve haver um intercepto na regressão
e) tudo o que precede
 
 
3.9) O estimador VI pode ser usado para eliminar potencialmente o viés resultante de
 
a) multicolinearidade
b) correlação serial
c) erros de medida nas variáveis
d) heterocedasticidade
e) tudo o que precede

 
3.10) A regressão de variáveis instrumentais usa instrumentos para:
 
a) estabelecer o Efeito Mozart
b) para aumentar o R2 da regressão
c) para eliminar a correlação serial
d) isolar movimentos em $X$ que não estão correlacionados com $u$
e) tudo o que precede

## Questão 5

Suponha que temos um modelo $y=\beta_0 + \beta_1 x + u$, onde $E\left[x_i u_i\right]\neq 0$. Você obtém uma variável $Z$ tal que $E\left[z_i u_i\right] = 0$.

a) Utilize a expressão $Cov(z_i, u_i) = 0$ para deduzir a forma do parâmetro $\beta_1$
nesse modelo.

b) Na letra (a), uma das hipóteses necessárias é “há correlação entre as variáveis X e Z”. Como isso aparece na forma estimada acima? Explique, intuitivamente, o sentido econômico dessa hipótese. Procure usar exemplos de um problema real.

c) Utilizando os análogos amostrais de (a), proponha um estimador para o parâmetro populacional. Chame esse estimador de $\hat\beta_{1,IV}$.

d) Outra forma de calcular $\hat\beta_{1,IV}$ é via MQ2E. Explique quais são os dois estágios da regressão.

e) Assuma agora que $y = X\beta + u$, onde $E\left[X' u\right] \neq 0$ e $X$ tenha dimensão $k > 1$.
Você obtém um conjunto de $g \leq k$ variáveis $Z$ tal que $E\left[Z'u\right] = 0$. Perceba que X pode conter, por exemplo, apenas uma variável tal que $E\left[x_k u\right] \neq 0$ (endógena), o que já tornaria o modelo inválido. Dê uma intuição para o motivo do número de variáveis instrumentais ser necessariamente maior ou igual ao número de variáveis explicativas em $X$ que são correlacionadas com o termo de erro. O que acontece quando o número de variáveis instrumentais é estritamente maior que o número de variáveis endógenas?


## Solução

a) 

$$
\begin{aligned}
\operatorname{Cov}\left(z_{i}, u_{i}\right)=0 & \Longrightarrow \operatorname{Cov}\left(z_{i}, y_{i}-\beta_{0}-\beta_{1} x_{i}\right)=0 \Longrightarrow \operatorname{Cov}\left(z_{i}, y_{i}\right)-\operatorname{Cov}\left(z_{i}, \beta_{1} x_{i}\right)=0 \\
& \Longrightarrow \operatorname{Cov}\left(z_{i}, y_{i}\right)=\beta_{1} \operatorname{Cov}\left(z_{i}, x_{i}\right) \Longrightarrow \beta_{1}=\frac{\operatorname{Cov}\left(z_{i}, y_{i}\right)}{\operatorname{Cov}\left(z_{i}, x_{i}\right)}
\end{aligned}
$$

b) Aparece no denominador da expressão de $\beta_{1}$, ou seja, $\operatorname{Cov}\left(z_{i}, x_{i}\right) \neq 0$. Lembremse que, em uma regressão, estamos tentando usar a variação em uma variável $X$ para explicar a variação em outra variável, $Y$. Se acreditamos que há uma variação "ruim" em $X$, ou seja, uma endogeneidade de alguma forma, precisamos obter uma variação "limpa" para identificar apropriadamente os parâmetros. Portanto, precisamos que os instrumentos $Z$ induzam essa variação "limpa" em $X$. Para isso, deve haver alguma forma de relação entre $Z$ e $X$. No caso da convocação do Vietnã, em que tinhamos um instrumento binário, essa hipótese significa que as pessoas convocadas precisam ter uma probabilidade maior de ir para a guerra do que as pessoas não convocadas, ou seja, é necessário que ir para a guerra seja correlacionado com ser convocado.

c) Propomos o estimador baseado nos análogos amostrais das covariâncias populacionais.

$$
\hat{b}_{I V}=\frac{\sum_{i=1}^{n}\left(y_{i}-\bar{y}\right)\left(z_{i}-\bar{z}\right)}{\sum_{i=1}^{n}\left(x_{i}-\bar{x}\right)\left(z_{i}-\bar{z}\right)}
$$

d) O primeiro estágio é a regressão de $X$ em $Z$, com isso decompomos $X$ em duas partes, uma parte que é correlacionada com o erro da regressão, e outra parte não correlacionada com o erro. A regressão do primeiro estágio é

$$
X_{i}=\pi_{0}+\pi_{1} Z_{i}+\nu_{i}
$$

Com isso obtemos os valores preditos $\hat{X}_{i}=\hat{\pi}_{0}+\hat{\pi}_{1} Z_{i}$, que é o componente de $X$ não correlacionado com o erro. O segundo estágio consiste em usar esses valores preditos e regredir $Y$ neles

$$
Y_{i}=\beta_{0}+\beta_{1} \hat{X}_{i}+u_{i}
$$

Com isso obtemos $\beta_{0}^{2 S L S}, \beta_{1}^{2 S L S}$, os estimadores de MQO em dois estágios (MQ2E)

e) Para que possamos eliminar o problema da endogeneidade é necessário que haja no mínimo um instrumento para cada variável endógena. Para ser possível identificar e consequentemente estimar os valores preditos $\hat{x}_{k}$ para os $m$ parâmetros endógenos, é necessário ter no mínimo $m$ variáveis instrumentais. Caso contrário, o primeiro estágio não é factível. Quando temos mais instrumentos do que variáveis endógenas, é necessário utilizar o estimador MQ2E, uma vez que $Z^{\prime} X$ não será inversível. Devemos então usar a projeção de $X$ em $Z$ como mostrado no item anterior. Dessa forma, garantimos que $\hat{X}^{\prime} \hat{X}$ seja inversível.



## Questão 6

Um dos problemas mais simples de variáveis instrumentais é o caso onde $y_i=\alpha+\beta x_i+u_i$ , $E\left[x_i u_i\right] \neq 0$, e você obtém um instrumento binário (dummy) $z_i$, com $E\left[z_i u_i\right] = 0$

a) Mostre que o estimador de IV pode ser escrito como
$$
b_{Wald}=\frac{\bar{y}_1 - \bar{y}_0}{\bar{x}_1 - \bar{x}_0}
$$
Onde $\bar{y}_0$ e $\bar{x}_0$ são as médias amostrais de $x_i$ e $y_i$ considerando apenas a parte da amostra com $z_i = 0$, e que $\bar{y}_1$ e $\bar{x}_1$ são as médias amostrais considerando apenas a amostra com $z_i = 1$. Esse estimador, conhecido como estimador de Wald, foi proposto pelo próprio em 1940.

b) Pense no caso onde $x_i$ é uma variável dummy indicando um tratamento (por exemplo, $x_i = 1$ se o indivı́duo aplicou para um programa de retreinamento fornecido pelo governo). Interprete intuitivamente o estimador acima, lembrando que a média de uma variável dummy é a proporção de observações cujo valor de $x_i$ é igual à 1. Para ajudar na resposta, note que o estimador da letra (a) requer que $\bar{x}_1 - \bar{x}_0 \neq 0$.


## Solução

a) Primeiro vamos relembrar do estimador de IV no caso univariado com constante, onde

$$
\beta_{I V}=\frac{\operatorname{Cov}(z, y)}{\operatorname{Cov}(z, x)}=\frac{\mathbb{E}[Z Y]-\mathbb{E}[Z] \mathbb{E}[Y]}{\mathbb{E}[Z X]-\mathbb{E}[Z] \mathbb{E}[X]}
$$

Vamos assumir que a variável Z binária assume valor 1 com probabilidade $\mathrm{p}$ e valor zero com probabilidade (1-p). Nesse caso $\mathbb{E}[Z]=p$. Assim, nós temos que

$$\mathbb{E}[Z Y]=\mathbb{E}[\mathbb{E}[Z Y \mid Z]]=\mathbb{E}[Z \mathbb{E}[Y \mid Z]]=p \cdot 1 \cdot \mathbb{E}[Y \mid Z=1]+(1-p) \cdot 0 \cdot \mathbb{E}[Y \mid Z=0]=p \mathbb{E}[Y \mid z=1]$$

Além disso, nós também temos que

$$
\mathbb{E}[Y]=\mathbb{E}[\mathbb{E}[Y \mid Z]]=p \cdot \mathbb{E}[Y \mid Z=1]+(1-p) \cdot E[Y \mid Z=0]
$$

Então

$$
\operatorname{Cov}(Z, Y)=p \cdot E[Y \mid Z=1]-p \cdot(p \cdot E[Y \mid Z=1]+(1-p) \cdot \mathbb{E}[Y \mid z=0])
$$

Analogamente

$$
\operatorname{Cov}(Z, X)=p \cdot E[X \mid Z=1]-p \cdot(p \cdot E[X \mid Z=1]+(1-p) \cdot \mathbb{E}[X \mid z=0])
$$

Portanto,

$$
\begin{gathered}
\beta_{I V}=\frac{p \mathbb{E}[Y \mid Z=1]-\not p(p \cdot \mathbb{E}[Y \mid Z=1]+(1-p) \cdot \mathbb{E}[Y \mid Z=0])}{p \mathbb{E}[X \mid Z=1]-\not p(p \cdot \mathbb{E}[X \mid Z=1]+(1-p) \cdot \mathbb{E}[X \mid Z=0])} \\
=\frac{(1-p) \cdot(\mathbb{E}[Y \mid Z=1]-\mathbb{E}[Y \mid Z=0])}{(1-p) \cdot(\mathbb{E}[X \mid Z=1]-\mathbb{E}[X \mid Z=0])}=\frac{\mathbb{E}[Y \mid Z=1]-\mathbb{E}[Y \mid Z=0]}{\mathbb{E}[X \mid Z=1]-\mathbb{E}[X \mid Z=0]}
\end{gathered}
$$

No caso amostral nós temos que

$$
b_{I V}=\frac{\mathbb{E}[\widehat{Y \mid Z}=1]-\mathbb{E}[Y \widehat{\mid Z=0}]}{\mathbb{E}[\widehat{X \mid Z}=1]-\mathbb{E}[\widehat{X \mid Z}=0]}
$$

Em que

$$
\begin{aligned}
&\mathbb{E}[Y \widehat{\mid Z=} 1]=\bar{y}_{1}=\frac{1}{n_{1}} \sum_{i=1}^{N} y_{i} \\
&\mathbb{E}[Y \widehat{\mid Z=} 0]=\bar{y}_{0}=\frac{1}{n_{0}} \sum_{i=1}^{N} y_{i} \\
&\mathbb{E}[X \widehat{\mid Z=} 1]=\bar{x}_{1}=\frac{1}{n_{1}} \sum_{i=1}^{N} x_{i} \\
&\mathbb{E}[X \widehat{\mid Z=0}]=\bar{x}_{0}=\frac{1}{n_{0}} \sum_{i=1}^{N} x_{i}
\end{aligned}
$$

Portanto

$$
b_{I V}=b_{W a l d}=\frac{\overline{y_{1}}-\overline{y_{0}}}{\overline{x_{1}}-\overline{x_{0}}}
$$

b) A ideia aqui é que a necessidade de que $\bar{x}_{1}-\bar{x}_{0} \neq 0$ é a mesma coisa que dizer que o instrumento deve "afetar" a proporção de pessoas aderindo ao tratamento. Se observarmos os indivíduos com $z_{i}=1$ e $z_{i}=0$, eles devem ter proporções diferentes de adesão ao tratamento, o que significa que o instrumento está afetando a adesão ao programa. Ou seja, é relevante para aquela decisão.


## Questão 7

Suponha que você está interessado em estimar
$$y_i = \alpha + \beta x_i + u_i$$
onde $x_i$ é um escalar e $E\left[x_i u_i\right] \neq 0$. Você observa uma variável aleatória $z_i$, relevante no sentido de que $E\left[z_i x_i\right] \neq 0$, mas não não tem certeza se ela é válida como instrumento, ou seja, não é garantindo que $E\left[z_i u_i\right] = 0$. Você decide estimar o modelo por OLS e IV, usando os estimadores

$$b_{MQO}=\frac{\sum(x_i-\bar x)(y_i-\bar y)}{\sum (x_i-\bar x)^2} \text{ e } b_{VI}=\frac{\sum(z_i-\bar z)(y_i-\bar y)}{\sum (z_i-\bar z)(x_i-\bar x)}$$
Nesse exercício, queremos deduzir condições para as quais o estimador de MQO é uma opção melhor que o estimador de VI.

a) Mostre que o viés assintótico do MQO é igual à

$$plim(b_{MQO}) − \beta = \text{corr}(x_i, u_i)\frac{\sigma_u}{\sigma_x}$$

b) Mostre que o viés assintótico do IV é igual à

$$plim(b_{VI}) − \beta = \frac{\text{corr}(z_i, u_i)}{\text{corr}(z_i, x_i)}\frac{\sigma_u}{\sigma_x}$$

c) Use os resultados acima para deduzir quando o estimador de MQO é preferı́ve ao de VI, em termos de viés.

d) Você sabe o que são “instrumentos fracos”. Relacione a discussão sobre instrumentos fracos, isso é, um instrumento tal que $E\left[x_i z_i\right]$ tem um valor baixo, com o resultado da letra (c).


## Solução

a) Da fórmula do MQO temos que:

$$
\widehat{\beta}_{O L S}=\beta+\frac{\sum_{i=1}^{N}\left(x_{i}-\bar{x}\right) u_{i}}{\sum_{i=1}^{N}\left(x_{i}-\bar{x}\right)^{2}} \stackrel{p}{\rightarrow} \beta+\frac{\mathbb{C}\left(x_{i}, u_{i}\right)}{\mathbb{V}\left(x_{i}\right)}
$$

Se $n \rightarrow \infty$. Aqui, sabemos que $\mathbb{C}\left(x_{i}, u_{i}\right) \neq 0$ e usando $\operatorname{corr}\left(x_{i}, u_{i}\right)=\mathbb{C}\left(x_{i}, u_{i}\right) / \sigma_{x} \sigma_{u}$, podemos reescrever este termo como:

$$
\begin{aligned}
\operatorname{plim}\left(\widehat{\beta}_{O L S}\right) &=\beta+\frac{\operatorname{corr}\left(x_{i}, u_{i}\right) \sigma_{x} \sigma_{u}}{\sigma_{x}^{2}} \\
&=\beta+\operatorname{corr}\left(x_{i}, u_{i}\right) \times \frac{\sigma_{u}}{\sigma_{x}}
\end{aligned}
$$

b) Da expressão do estimador de $\widehat{\beta}_{I V}$, temos que:

$$
\begin{aligned}
\widehat{\beta}_{I V} &=\beta+\frac{\sum_{i=1}^{N}\left(z_{i}-\bar{z}\right) u_{i}}{\sum_{i=1}^{N}\left(z_{i}-\bar{z}\right)\left(x_{i}-\bar{x}\right)} \\
& \stackrel{p}{\rightarrow} \beta+\frac{\mathbb{C}\left(z_{i}, u_{i}\right)}{\mathbb{C}\left(z_{i}, x_{i}\right)}
\end{aligned}
$$

Se $n \rightarrow \infty$. Lembrando que $\mathbb{C}(A, B)=\operatorname{corr}(A, A) \sigma_{A} \sigma_{B}$, com qualquer variável $A$ e $B$,

$$
\begin{aligned}
\operatorname{plim}\left(\widehat{\beta}_{I V}\right)-\beta &=\frac{\mathbb{C}\left(z_{i}, u_{i}\right)}{\mathbb{C}\left(z_{i}, x_{i}\right)}=\frac{\operatorname{corr}\left(z_{i}, u_{i}\right) \sigma_{z} \sigma_{u}}{\operatorname{corr}\left(z_{i}, x_{i}\right) \sigma_{z} \sigma_{x}} \\
&=\frac{\operatorname{corr}\left(z_{i}, u_{i}\right)}{\operatorname{corr}\left(z_{i}, x_{i}\right)} \times \frac{\sigma_{u}}{\sigma_{x}}
\end{aligned}
$$

c) Note que o estimador de MQO é preferível em termos de menor viés assintótico quando:

$$
\begin{aligned}
&\operatorname{corr}\left(x_{i}, u_{i}\right) \times \frac{\sigma_{u}}{\sigma_{x}} \leq \frac{\operatorname{corr}\left(z_{i}, u_{i}\right)}{\operatorname{corr}\left(z_{i}, x_{i}\right)} \times \frac{\sigma_{u}}{\sigma_{x}} \\
&\operatorname{corr}\left(x_{i}, u_{i}\right) \leq \frac{\operatorname{corr}\left(z_{i}, u_{i}\right)}{\operatorname{corr}\left(z_{i}, x_{i}\right)}
\end{aligned}
$$

d) O resultado acima mostra que quando o instrumento é "fraco", ou cor $\left(x_{i}, z_{i}\right)$ é muito pequena, precisamos que $\operatorname{corr}\left(z_{i}, u_{i}\right)$ também seja pequena o suficiente para justificar o uso do IV. Note que se $\operatorname{corr}\left(x_{i}, z_{i}\right)$ tende a zero, o viés assintótico de IV tende a ser muito grande. 



## Questão 8

Neste problema você deve estabelecer a equivalência algébrica entre MQ2E, a razão entre estimativas MQO em forma reduzida e o estimador de VI. Considere um modelo com uma única (suspeito) variável endógena (variáveis já em desvio):

\begin{align}
y_1&=\alpha_1 y_2 + u_1\\
y_1&=\pi_1 z + v_1\\
y_2&=\pi_2 z + v_2
\end{align}

Para maior clareza de notação, usamos $y_2$ como a variável endógena suspeita e $z$ como a variável exógena que serve como instrumento para $y_2$. A segunda e terceira equações são a forma reduzida para $y_1$ e $y_2$, respectivamente.

Sabemos que um estimador de $\alpha_1$ é o estimador MQ2E usando o instrumento z. Considere um estimador alternativo de $\alpha_1$: i) estimar a forma reduzida de $y_1$ e $y_2$ por MQO; ii) $\hat\alpha_1^{alt}=\hat\pi_1/\hat\pi_2$

a) Mostre a equivalência numérica entre $\hat\alpha_1^{2E}$ e $\hat\alpha_1^{alt}$

b) Mostre a equivalência numérica entre $\hat\alpha_1^{VI}$ e $\hat\alpha_1^{alt}$


## Solução

a) Começamos com o estimador MQ2E no primeiro estágio. A previsão de $y_2$ será $\hat{y}_2=\hat{\pi}_2z$, onde $\hat{\pi}_2=\frac{\sum z y_2}{\sum z^2}$.

No segundo estágio regredimos $y_1$ contra $\hat{y}_2$ e portanto:

$$
\begin{align*}
\hat{\alpha}_1^{2E}&=\frac{\sum \hat{y}_2 y_1}{\sum \hat{y}_2^2}\\
&=\frac{\sum \hat{\pi}_2z y_1}{\sum (\hat{\pi}_2z)^2}\\
&=\frac{1}{\hat{\pi}_2}\frac{\sum z y_1}{\sum z^2}\\
&= \frac{\hat{\pi}_1}{\hat{\pi}_2}
\end{align*}
$$
uma vez que $\frac{\sum z y_1}{\sum z^2}$ é justamente o estimador de $\pi_1$ na forma reduzida de $y_1$.

b) O estimador de VI será:

$$
\begin{align*}
\hat{\alpha}_1^{VI}&=\frac{\sum z y_1}{\sum z y_2}\\
&=\frac{\sum z y_1 / \sum z^2}{\sum z y_2 / \sum z^2}\\
&=\frac{\hat{\pi}_1}{\hat{\pi}_2}
\end{align*}
$$




## Questão 9

O objetivo deste exercı́cio é comparar as estimativas e erros padrão corretamente obtidos usando MQ2E com aqueles obtidos usando procedimentos inadequados. Use a base WAGE2.dta para esse exercı́cio.

a) Estime a equação abaixo usando MQ2E
$$\log(wage) = \beta_0 + \beta_1 educ + \beta_2 exper + \beta_3 tenure + \beta_4 black + u,$$

onde `sibs` é uma variável instrumental para `educ`. Reporte os resultados.

b) Agora, execute manualmente o MQ2E. Ou seja, primeiro faça a regressão de $educ_i$ em $sibs_i$, $exper_i$, $tenure_i$ e $black_i$ e obtenha os valores ajustados, $\widehat{educ}_i$ $i = 1, \ldots , n$. Em seguida, execute a regressão de segundo estágio $\log(wage_i)$ em $\widehat{educ}_i$, $exper_i$, $tenure_i$ e $black_i$. Verifique se os $\beta_j$ são idênticos aos obtidos no item a) e os erros padrão são um pouco diferentes. Os erros padrão obtidos da regressão do segundo estágio ao realizar manualmente MQ2E são inadequados.

c) Agora, use o seguinte procedimento de duas etapas, que geralmente produz estimativas inconsistentes de $\beta_j$, e não apenas erros padrão incorretos. Na etapa um, regresse $educ_i$ em $sibs_i$ apenas e obtenha os valores ajustados, digamos $\widetilde{educ}_i$. (Observe que esta é uma regressão de primeiro estágio incorreta). Em seguida, na segunda etapa, execute a regressão de $\log(wage)$ em $\widetilde{educ}_i$, $exper_i$ , $tenure_i$ e $black_i$. Como a estimativa desse procedimento incorreto de duas etapas se compara à estimativa correta de MQ2E do retorno à educação?


## Solução

```{r q5-setup, echo=TRUE}
library(haven)
library(fixest)

# Lendo o arquivo de dados
WAGE2 <- read_dta("data/WAGE2.dta")
```

```{r q5-a, echo=TRUE}
# a)
mq2e <- feols(log(wage) ~ exper + tenure + black | educ ~ sibs,
              data = WAGE2)
etable(mq2e)
```

```{r q5-b, echo=TRUE}
# b)
cpWAGE2 <- WAGE2
first_stage <- feols(educ ~ sibs + exper + tenure + black,
                     data = cpWAGE2)
cpWAGE2$educ_hat <- predict(first_stage)

second_stage <- feols(log(wage) ~ educ_hat + exper + tenure + black,
              data = cpWAGE2)
etable(list(VI = mq2e, Manual = second_stage))
```

```{r q5-c, echo=TRUE}
# c)
wrong_1st <- feols(educ ~ sibs,
                   data = cpWAGE2)
cpWAGE2$wrong_educ_hat <- predict(wrong_1st)

wrong_2st <- feols(log(wage) ~ wrong_educ_hat + exper + tenure + black,
              data = cpWAGE2)
etable(list(VI = mq2e, Manual = second_stage, MQ2E_Errado = wrong_2st ))
```




## Referências