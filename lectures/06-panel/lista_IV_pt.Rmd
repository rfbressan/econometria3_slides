---
title: "Dados em Painel"
subtitle: "Lista de Exercícios IV"
author: "Rafael Bressan"
date: "UDESC/Esag </br> Data devida: 24/11/2022"
output: html_document
params:
    solutions: false
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)

library(data.table)
library(plm)
library(fixest)
library(modelsummary)
```


## Questão 1

Considere o modelo:

$$
\begin{align*}
y_{it} &= \beta_0 + \beta_1 x_{it} + \varepsilon_{it}\\
\varepsilon_{it} &= a_i + u_{it}
\end{align*}
$$
Os dados consistem de $N$ observações de $y$ (salário) e $x$ (escolaridade) para $T = 2$ períodos de tempo.

a) Interprete possíveis variáveis omitidas que possam fazer parte do efeito fixo
$a_i$. Você acredita que $a_i$ possa ser não-correlacionado com $x$? Que implicações isso tem para a escolha de sua estratégia de estimação de $\beta_1$?

b) Um pesquisador propõe eliminar o efeito fixo, $a_i$ , estimando por MQO um modelo em primeira diferenças do tipo:

$y_{i1} − y_{i0} = \beta_1 (x_{i1} − x_{i0}) + (u_{i1} − u_{i0})$

Outro pesquisador propõe eliminar o efeito fixo estimando por MQO um modelo
de diferenças em relação à média:

$y_{it}-\bar{y}_i=\beta_1 (x_{it}-\bar{x}_i)+(u_{it}-\bar{u}_i)$

Onde $\bar{y}_i=\frac{1}{T}\sum_{t}y_{it}$

é a média da variável $y$ para o indivíduo $i$.

Um terceiro pesquisador propõe ainda a inclusão de variáveis dummy $d_i$ indicando se a observação pertence ao indivíduo $i$, estimando assim um MQO do modelo:

$y_{it} = \beta_1 x_{it} + \sum_{i=1}^N a_i d_i + u_{it}$

Qual destes estimadores é melhor? Por quê?


```{r , results='asis', include=!params$solutions}
cat("\\begin{comment}\n")
```


## Solução

a) Características não observáveis como habilidade e esforço podem estar presente no termo $a_i$. Dificilmente estas características não sejam correlacionadas com a escolaridade ($x_{it}$), pois, tipicamente pessoas mais escolarizadas possuem tanto habilidade para estudos quanto suportam maiores cargas de esforço (se pensarmos que estudar requer esforço). 

Sabemos que se alguma variável omitida em nossa regressão é correlacionada com qualquer um dos regressores, nossa estimativa de MQO será potencialmente viesada.

b) Os três estimadores serão consistentes, resultando no mesmo valor estimado de $\beta_1$. A escolha deverá recair sobre qual estimador é mais eficiente. Aquele que provê menores erros padrão das estimativas.


```{r , results='asis', include=!params$solutions}
cat("\\end{comment}")
```


## Questão 2

Considere um modelo simples de taxa de criminalidade ($crim$) em função de desemprego ($desemp$). Temos um painel com $T=2$ e heterogeneidade não observada $a_i$. Especificamos o modelo com uma variável _dummy_ para identificar $t=2$.

$$crim_{it}=\beta_0+\delta_0 D_{t2}+\beta_1 desemp_{it}+a_i+u_{it}.$$

a) Escreva o modelo em primeira diferença (PD) e mostre que esta especificação elimina a heterogeneidade.

b) Escreva o modelo com a transformação _within_ (dentro do grupo) e mostre que esta especificação também elimina a heterogeneidade.

c) Suponha que $\beta_1 > 0$ e, $\Delta u_i$ e $\Delta desemp_i$ são negativamente correlacionados. Qual é o viés no estimador de $\beta_1$ via MQO PD?

```{r , results='asis', include=!params$solutions}
cat("\\begin{comment}\n")
```


## Solução

a) $\Delta crim_{i}=\delta_0+\beta_1\Delta desemp_i+\Delta u_i$. Veja que $\alpha_i$ foi elimiando da equação. Além disso, perceba que a dimensão temporal também foi eliminada, já que o painel original apresentava apenas dois períodos.

b) $\bar y_i = \beta_0 + \delta_0/2 + \beta_1\bar x_i+\alpha_i+\bar u_i$, logo:

$\ddot{crim}_{it}=\delta_0(D_{t2}-0.5) + \beta_1\ddot{desemp}_{it}+\ddot{u}_{it}$

c) Em PD: 

$$\hat\beta_1=\beta_1+\underbrace{\frac{\sum_i \Delta u_i(\Delta desemp_i - \bar{\Delta desemp_i})}{\sum_i(\Delta desemp_i - \bar{\Delta desemp_i})^2}}_{\propto cov(\Delta u_i, \Delta desemp_i)}$$

Como $cov(\Delta u_i, \Delta desemp_i)<0$, o viés em $\hat\beta_1$ será de atenuação.


```{r , results='asis', include=!params$solutions}
cat("\\end{comment}")
```



## Questão 3

Considere o seguinte modelo em painel com $i=1, \ldots , N$ e $t=1, \ldots , T$.

$$y_{it}=\beta_1 x1_{it}+\ldots +\beta_k xk_{it}+a_i+u_{it}.$$
Se os erros idiossincráticos $u_{it}$ forem serialmente **não** correlacionados com variância constante $\sigma_u^2$, mostre que o estimador de primeira diferença irá induzir um correlação de $\Delta u_{i,t}$ com $\Delta u_{i,t+1}$ de $-0,5$.

```{r , results='asis', include=!params$solutions}
cat("\\begin{comment}\n")
```


## Solução

Comece escrevendo o modelo em primeira diferença:

$\Delta y_{it}=\beta_1 \Delta x1_{it}+\ldots +\beta_k \Delta xk_{it}+\Delta u_{it}$

A variância $Var(\Delta u_{it})$ é $E[(\Delta u_{it})^2]=E[u_{i,t}^2-2u_{i,t}u_{i,t-1}+u_{i,t-1}^2]=2\sigma_u^2$.

Já a covariância entre $\Delta u_{i,t}$ e $\Delta u_{i,t+1}$ é $E[(u_{i,t}-u_{i,t-1})(u_{i,t+1}-u_{i,t})]=E[-u_{i,t}^2]=-\sigma_u^2$.

Portanto a correlação entre $\Delta u_{i,t}$ e $\Delta u_{i,t+1}$ é $-\sigma_u^2 / (2\sigma_u^2)=-0,5$.


```{r , results='asis', include=!params$solutions}
cat("\\end{comment}")
```



## Questão 4

Com uma única variável explicativa, a equação de média temporal é

$$\bar{y}_i=\beta_0+\beta_1\bar{x}_i+a_i+\bar{u}_i.$$
Tendo incluído um intercepto, temos que $E[a_i]=0$. Suponha que $\bar{u}_i$ seja não correlacionado com $\bar{x}_i$, mas que $cov(\bar{x}_i, a_i)=\sigma_{xa}$.

a) Sendo $\tilde{\beta}_1$ o estimador MQO da especificação acima, mostre que $\operatorname{plim}\tilde{\beta}_1=\beta_1+\sigma_{xa}/Var[\bar{x}_i]$ (lembre-se $a_i$ é não observado).

b) Suponha também que $x_{it}$ seja serialmente não correlacionado com variância constante igual a $\sigma_x^2$. Mostre que $\operatorname{plim}\tilde{\beta}_1=\beta_1+T\sigma_{xa}/\sigma_x^2$

```{r , results='asis', include=!params$solutions}
cat("\\begin{comment}\n")
```


## Solução

a) 

$$
\begin{align*}
\tilde{\beta}_1&=\frac{\sum_i(\bar x_i - \bar x)\bar y_i}{\sum_i(\bar x_i -\bar x)^2}\\
&=\frac{\sum_i(\bar x_i - \bar x)(\beta_0+\beta_1\bar{x}_i+a_i+\bar{u}_i)}{\sum_i(\bar x_i -\bar x)^2}\\
&=\beta_1+\frac{\sum_i(\bar x_i - \bar x)\bar a_i}{\sum_i(\bar x_i -\bar x)^2}+\frac{\sum_i(\bar x_i - \bar x)\bar u_i}{\sum_i(\bar x_i -\bar x)^2}\\
\text{plim}\tilde{\beta}_1&=\beta_1+\frac{cov(a_i, \bar x_i)}{Var[\bar x_i]}
\end{align*}
$$

b) Neste caso $Var[\bar x_i]= Var[T^{-1}\sum_i x_{it}]$, logo

$$Var[\bar x_i]=T^{-1}\sigma_x^2$$
Substituindo na expressão do item a), temos

$$\text{plim}\tilde{\beta}_1=\beta_1+\frac{T\sigma_{xa}}{\sigma_x^2}$$


```{r , results='asis', include=!params$solutions}
cat("\\end{comment}")
```



## Questão 5

A regressão linear de efeitos fixos em duas vias ( _two way fixed effects_ - TWFE) tornou-se um método padrão para estimar efeitos causais a partir de dados em painel. Muitos pesquisadores aplicados usam o estimador TWFE para ajustar os fatores de confusão não observados específicos da unidade e específicos do tempo ao mesmo tempo. A especificação é simples:

$$y_{it}=\beta_1 x_{it}+\alpha_i+\theta_t+u_{it},$$
onde $\alpha_i$ representa características não observadas do indivíduo e $\theta_t$ efeitos temporais também não observados (ou não medidos). Se qualquer um dos efeitos fixos forem correlacionados com o regressor $x_{it}$, então o estimador agrupado (ie., _pooled_) de MQO será viesado.

a) Como você poderia estimar $\beta_1$ sem incorrer em viés?

b) Conhecemos a transformação dentro do grupo (ie., _within_) para apenas um efeito fixo de indivíduo. Proponha uma transformação similar que elimine ambos os fatores de confusão simultaneamente. (Dica: temos dois tipos de grupos agora. Você pode querer descontar as médias intragrupo e recompor a média geral.)

c) Suponha que existam apenas dois grupos de indivíduos, $i \in\{C, T\}$ e dois períodos, $t\in\{t_1, t_2\}$ e que o regressor é um indicador de tratamento

$$x_{it}=\begin{cases}
1, \text{ se } i=T \text{ e } t=t_2\\
0, \text{ caso contrário.}
\end{cases}$$
Mostre que $\beta_1$ neste caso é

$$
\begin{align*}
\beta_1&=E[y_{it}|i\in T, t=t_2] - E[y_{it}|i\in T, t=t_1]\\
&-\lbrace E[y_{it}|i\in C, t=t_2] - E[y_{it}|i\in C, t=t_1]\rbrace
\end{align*}
$$


```{r , results='asis', include=!params$solutions}
cat("\\begin{comment}\n")
```


## Solução

a) As características não observadas e correlacionadas com o regressor $x_{it}$ causam viés no estimador $\hat\beta_1^{MQO}$. Utilizar somente a primeira diferença temporal não irá eliminar o efeito fixo $\theta_t$. Podemos, portanto, expandir em dummies **ambos** os efeitos fixos e estimar a regressão com MQO, ou utilizar uma transformação intragrupo adequada, que será mostrada no item a seguir.

b) Seja $\bar y_i=T^{-1}\sum_t y_{it}$, $\bar y_t=N^{-1}\sum_i y_{it}$ e $\bar y=(NT)^{-1}\sum_i\sum_t y_{it}$. Então a transformação intragrupo em duas vias é dada por:

$$\ddot{y}_{it}=(y_{it}-\bar y)-(\bar y_{i}-\bar y)-(\bar y_{t}-\bar y)=y_{it}-\bar y_{i}-\bar y_{t} + \bar y.$$

Agora basta mostrar que $\ddot{y}_{it}=\beta_1\ddot{x}_{it}+\ddot{u}_{it}$.

$\bar y_i=\beta_1\bar x_i+\alpha_i+\bar\theta+\bar u_i$

$\bar y_t=\beta_1\bar x_t+\bar\alpha+\theta_t+\bar u_t$

$\bar y=\beta_1\bar x+\bar\alpha+\bar\theta+\bar u$

$$
\begin{align*}
\ddot{y}_{it}&=y_{it}-\bar y_{i}-\bar y_{t} + \bar y\\
&=\beta_1 x_{it}+\alpha_i+\theta_t+u_{it}\\
&-\beta_1\bar x_i+\alpha_i+\bar\theta+\bar u_i\\
&-\beta_1\bar x_t+\bar\alpha+\theta_t+\bar u_t\\
&+\beta_1\bar x+\bar\alpha+\bar\theta+\bar u\\
&=\beta_1(x_{it}-\bar x_i-\bar x_t+\bar x)+(u_{it}-\bar u_i-\bar u_t+\bar u)\\
&=\beta_1\ddot{x}_{it}+\ddot{u}_{it}.
\end{align*}
$$

Considerando que $u_{it}$ é estritamente exógeno em relação a $x_{it}$, então $\ddot{u}_{it}$ também será exógeno em relação a $\ddot{x}_{it}$. Logo, não existirá viés em estimar a regressão $\ddot{y}_{it}=\beta_1\ddot{x}_{it}+\ddot{u}_{it}$ por MQO.

c) Neste caso podemos expandir em dummies os efeitos fixos.

$$y_{it}=\beta_0+\beta_1x_{it}+\delta_T\mathbb{1}_T + \delta_{t2}\mathbb{1}_{t2} + u_{it}$$
onde as funções indicadoras são tais que 

$$
\mathbb{1}_T=
\begin{cases}
1, &\text{se }i\in T\\
0, &\text{caso contrário}
\end{cases}
$$

$$
\mathbb{1}_{t2}=
\begin{cases}
1, &\text{se }t=t_2\\
0, &\text{caso contrário.}
\end{cases}
$$
Assim, temos que:

$E[y_{it}|i\in C, t=t_1]=\beta_0$

$E[y_{it}|i\in C, t=t_2]=\beta_0+\delta_{t2}$

$E[y_{it}|i\in T, t=t_1]=\beta_0+\delta_T$

$E[y_{it}|i\in T, t=t_2]=\beta_0+\delta_{t2}+\delta_T+\beta_1$.

Portanto, podemos escrever $\beta_1$ em termos dos valores esperados condicionais

$$
\begin{align*}
\beta_1&=E[y_{it}|i\in T, t=t_2] - E[y_{it}|i\in T, t=t_1]\\
&-\lbrace E[y_{it}|i\in C, t=t_2] - E[y_{it}|i\in C, t=t_1]\rbrace
\end{align*}
$$


```{r , results='asis', include=!params$solutions}
cat("\\end{comment}")
```


## Questão 6

Este exercício será baseado em um conjunto de dados da Organização Mundial da Saúde que se relaciona com resultados agregados dos sistemas de saúde nas economias mundiais. O arquivo é `WHO.csv`, carregue-o em seu software de preferência.

As variáveis nos conjuntos de dados são

| Variável          | Descrição                                         |
|-------------------|---------------------------------------------------|
| YEAR              | 1993, ..., 1997                                   |
| COMP, LOGCOMP     | medida composta de obtenção de cuidados de saúde  |
| DALE, LOGDALE     | expectativa de vida ajustada por deficiência      |
| HLTHEXP,LOGHEXP   | despesas de saúde                                 |
| EDUC, LOGEDUC     | educação média                                    |
| LOGHEXP2          | quadrado de LOGHEXP                               |
| LOGEDUC2          | quadrado de LOGEDUC                               |
| LOGED_EX          | LOGHEXP * LOGEDUC                                 |
| GINI              | Coeficiente de Gini de distribuição de renda      |
| TROPICS           | Variável dummy para localização tropical          |
| POPDEN, LOGPOPDEN | densidade populacional                            |
| PUBTHE            | proporção das despesas de saúde que são públicas  |
| GDPC,LOGGDPC      | renda per capita                                  |
| T93,...,T97       | Variáveis dummy de ano                            |
| GEFF              | Medida do Banco Mundial de eficácia do governo    |
| VOICE             | Medida do Banco Mundial de extensão da Democracia |
| OECD              | Variável dummy, membro da OCDE da ONU em 1997     |
| MEANLCMP          | (média de 5 anos) de LOGCMP                       |
| MEANLHC,MEAHLHC2  | média do país e seu quadrado de LOGEDUC           |
| MEANLEXP          | média do país de LOGHEXP                          |

Além do nome e código do país.

```{r load-who}
who <- fread("WHO.csv")
```

```{r panel}
plm_who <- pdata.frame(who, index = c("ID", "YEAR"))

```

a) Quais são as dimensões do painel? É balanceado?

Considere a partir de agora a seguinte regressão para explicar oferta de serviços de saúde

$$LOGCOMP_{it} = \beta_0 + \beta_1 LOGEDUC_{it} + \beta_2 LOGHEXP_{it} + \beta_3 LOGED-EX_{it} + \varepsilon_{it}$$
ou seja, a oferta de saúde é explicada pela educação média e despesas com saúde, incluindo sua interação.

b) Estime a versão agrupada desta especificação e apresente os resultados.

```{r mqo-pool, include=FALSE}
mqo_pool <- plm(LOGCOMP~LOGEDUC*LOGHEXP,
                data = plm_who,
                model = "pooling")
summary(mqo_pool)
```

c) Você não acredita que este modelo esteja capturando a verdadeira influência da educação na oferta de saúde, afinal, os países na amostra são muito diferentes. Discorra sobre quais fatores individuais de cada país podem influenciar no provimento de serviços de saúde. Estes fatores seriam correlacionados com o nível educacional?

d) Escolha um modelo que julgue o mais adequado para estimar o efeito da educação na oferta de saúde, apresente e comente sobre os resultados.

```{r mqo-ocde, include=FALSE}
mqo_fe <- plm(LOGCOMP~LOGEDUC*LOGHEXP,
              data = plm_who,
              model = "within")
summary(mqo_fe)
```

e) Como os resultados do item anterior se comparam a estimação do MQO agrupado? Qual resultado é mais confiável, por quê?

```{r plm-haus, include=FALSE}
phtest(mqo_fe, mqo_pool)
```


```{r , results='asis', include=!params$solutions}
cat("\\begin{comment}\n")
```


## Solução

a)

```{r q6a, results='asis', echo=TRUE}
pdim(plm_who)
```

b) 

```{r q6b, results="asis", echo=TRUE}
mqo_pool <- plm(LOGCOMP~LOGEDUC*LOGHEXP,
                data = plm_who,
                model = "pooling")
msummary(mqo_pool)
```

c) A medida de educação é geral, ou seja, engloba educação fornecida pelo governo também. Desta forma, podemos pensar que outras variáveis que captam o tamanho/eficiência do governo podem estar influenciando tanto educação quanto o provimento de serviços de saúde. Controlar para tais covariadas parece ser apropriado. Renda per capta, despesas públicas de saúde e eficácia do governo poderiam ser incluídas.

d) Podemos incluir as variáveis de controle acima e reestimar os resultados. Além destes controles explícitos, poderíamos também incluir efeitos fixos de país para tentar controlar por qualquer outra heterogeneidade não observada relativa ao país.

```{r q6d, results='asis', echo=TRUE}
mqo_ctrl <- plm(LOGCOMP~LOGEDUC*LOGHEXP+PUBTHE+LOGGDPC+GEFF,
              data = plm_who,
              model = "pooling")

mqo_fe <- plm(LOGCOMP~LOGEDUC*LOGHEXP+PUBTHE+LOGGDPC+GEFF,
              data = plm_who,
              model = "within")
msummary(list(MQO = mqo_pool, `MOQ+` = mqo_ctrl, EF = mqo_fe))
```

e) A variável de educação LOGEDUC tem sua magnitude reduzida para 0.091, porém ainda estatisticamente significativa. Ou seja, quanto mais educado um país, maior a oferta de serviços de saúde. Esta oferta parece ser completamente oriunda da educação, uma vez que as despesas não são relevantes. Nossa escolha de variáveis extras para controle foi quase que completamente absorvida pelo modelo de efeitos fixos. A explicação é que, apesar de ser um painel, nossos dados não possuem variação temporal nas variáveis PUBTHE e LOGGDPC. Sem variação temporal, o efeito fixo de país absorve estas variáveis. Sobrou apenas a eficácia do governo, GEFF, que tampouco foi estatisticamente significativa.

```{r , results='asis', include=!params$solutions}
cat("\\end{comment}")
```

