---
title: "Dados em Painel"
subtitle: "Lista de Exercícios IV"
author: "Rafael Bressan"
date: "UDESC/Esag </br> Data devida: 24/11/2022"
output: html_document
params:
    solutions: false
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)

library(data.table)
library(plm)
library(fixest)
```


## Questão 1

Considere o modelo:

$$
\begin{align*}
y_{it} &= \beta_0 + \beta_1 x_{it} + \varepsilon_{it}\\
\varepsilon_{it} &= a_i + u_{it}
\end{align*}
$$
Os dados consistem de $N$ observações de $y$ (salário) e $x$ (escolaridade) para $T = 2$ períodos de tempo.

a) Interprete possíveis variáveis omitidas que possam fazer parte do efeito fixo
$a_i$. Você acredita que $a_i$ possa ser não-correlacionado com $x$? Que implicações isso tem para a escolha de sua estratégia de estimação de $\beta_1$?

b) Um pesquisador propõe eliminar o efeito fixo, $a_i$ , estimando por MQO um modelo em primeira diferenças do tipo:

$y_{i1} − y_{i0} = \beta_1 (x_{i1} − x_{i0}) + (u_{i1} − u_{i0})$

Outro pesquisador propõe eliminar o efeito fixo estimando por MQO um modelo
de diferenças em relação à média:

$y_{it}-\bar{y}_i=\beta_1 (x_{it}-\bar{x}_i)+(u_{it}-\bar{u}_i)$

Onde $\bar{y}_i=\frac{1}{T}\sum_{t}y_{it}$

é a média da variável $y$ para o indivíduo $i$.

Um terceiro pesquisador propõe ainda a inclusão de variáveis dummy $d_i$ indicando se a observação pertence ao indivíduo $i$, estimando assim um MQO do modelo:

$y_{it} = \beta_1 x_{it} + \sum_{i=1}^N a_i d_i + u_{it}$

Qual destes estimadores é melhor? Por quê?

## Questão 2

Considere um modelo simples de taxa de criminalidade ($crim$) em função de desemprego ($desemp$). Temos um painel com $T=2$ e heterogeneidade não observada $a_i$. Especificamos o modelo com uma variável _dummy_ para identificar $t=2$.

$$crim_{it}=\beta_0+\delta_0 D_{t2}+\beta_1 desemp+a_i+u_{it}.$$

a) Escreva o modelo em primeira diferença (PD) e mostre que esta especificação elimina a heterogeneidade.

b) Escreva o modelo com a transformação _within_ (dentro do grupo) e mostre que esta especificação também elimina a heterogeneidade.

c) Suponha que $\beta_1 > 0$ e, $\Delta u_i$ e $\Delta desemp_i$ são negativamente correlacionados. Qual é o viés no estimador de $\beta_1$ via MQO PD?

## Questão 3

Considere o seguinte modelo em painel com $i=1, \ldots , N$ e $t=1, \ldots , T$.

$$y_{it}=\beta_1 x1_{it}+\ldots +\beta_k xk_{it}+a_i+u_{it}.$$
Se os erros idiossincráticos $u_{it}$ forem serialmente **não** correlacionados com variância constante $\sigma_u^2$, mostre que o estimador de primeira diferença irá induzir um correlação de $\Delta u_{i,t}$ com $\Delta u_{i,t+1}$ de $-0,5$.

```{r , results='asis', include=!params$solutions}
cat("\\begin{comment}\n")
```


## Solução

Comece escrevendo o modelo em primeira diferença:

$\Delta y_{it}=\beta_1 \Delta x1_{it}+\ldots +\beta_k \Delta xk_{it}+\Delta u_{it}$

A variância $Var(\Delta u_{it})$ é $E[(\Delta u_{it})^2]=E[u_{i,t}^2-2u_{i,t}u_{i,t-1}+u_{i,t-1}^2]=2\sigma_u^2$.

Já a covariância entre $\Delta u_{i,t}$ e $\Delta u_{i,t+1}$ é $E[(u_{i,t}-u_{i,t-1})(u_{i,t+1}-u_{i,t})]=E[-u_{i,t}^2]=-\sigma_u^2$.

Portanto a correlação entre $\Delta u_{i,t}$ e $\Delta u_{i,t+1}$ é $-\sigma_u^2 / (2\sigma_u^2)=-0,5$.


```{r , results='asis', include=!params$solutions}
cat("\\end{comment}")
```



## Questão 4

Com uma única variável explicativa, a equação de média temporal é

$$\bar{y}_i=\beta_0+\beta_1\bar{x}_i+a_i+\bar{u}_i.$$
Tendo incluído um intercepto, temos que $E[a_i]=0$. Suponha que $\bar{u}_i$ seja não correlacionado com $\bar{x}_i$, mas que $cov(\bar{x}_i, a_i)=\sigma_{xa}$.

a) Sendo $\tilde{\beta}_1$ o estimador MQO da especificação acima, mostre que $\operatorname{plim}\tilde{\beta}_1=\beta_1+\sigma_{xa}/Var[\bar{x}_i]$ (lembre-se $a_i$ é não observado).

b) Suponha também que $x_{it}$ seja serialmente não correlacionado com variância constante igual a $\sigma_x^2$. Mostre que $\operatorname{plim}\tilde{\beta}_1=\beta_1+T\sigma_{xa}/\sigma_x^2$


## Questão 5

A regressão linear de efeitos fixos em duas vias ( _two way fixed effects_ - TWFE) tornou-se um método padrão para estimar efeitos causais a partir de dados em painel. Muitos pesquisadores aplicados usam o estimador TWFE para ajustar os fatores de confusão não observados específicos da unidade e específicos do tempo ao mesmo tempo. A especificação é simples:

$$y_{it}=\beta_1 x_{it}+\alpha_i+\theta_t+u_{it},$$
onde $\alpha_i$ representa características não observadas do indivíduo e $\theta_t$ efeitos temporais também não observados (ou não medidos). Se qualquer um dos efeitos fixos forem correlacionados com o regressor $x_{it}$, então o estimador agrupado (ie., _pooled_) de MQO será viesado.

a) Como você poderia estimar $\beta_1$ sem incorrer em viés?

b) Conhecemos a transformação dentro do grupo (ie., _within_) para apenas um efeito fixo de indivíduo. Proponha uma transformação similar que elimine ambos os fatores de confusão simultaneamente. (Dica: temos dois tipos de grupos agora. Você pode querer descontar as médias intragrupo e recompor a média geral.)

c) Suponha que existam apenas dois grupos de indivíduos, $i \in\{C, T\}$ e dois períodos, $t\in\{t_1, t_2\}$ e que o regressor é um indicador de tratamento

$$x_{it}=\begin{cases}
1, \text{ se } i=T \text{ e } t=t_2\\
0, \text{ caso contrário.}
\end{cases}$$
Mostre que $\beta_1$ neste caso é

$$
\begin{align*}
\beta_1&=E[y_{it}|i\in T, t=t_2] - E[y_{it}|i\in T, t=t_1]\\
&-\lbrace E[y_{it}|i\in C, t=t_2] - E[y_{it}|i\in C, t=t_1]\rbrace
\end{align*}
$$

## Questão 6

Este exercício será baseado em um conjunto de dados da Organização Mundial da Saúde que se relaciona com resultados agregados dos sistemas de saúde nas economias mundiais. O arquivo é `WHO.csv`, carregue-o em seu software de preferência.

As variáveis nos conjuntos de dados são

| Variável          | Descrição                                         |
|-------------------|---------------------------------------------------|
| YEAR              | 1993, ..., 1997                                   |
| COMP, LOGCOMP     | medida composta de obtenção de cuidados de saúde  |
| DALE, LOGDALE     | expectativa de vida ajustada por deficiência      |
| HLTHEXP,LOGHEXP   | despesas de saúde                                 |
| EDUC, LOGEDUC     | educação média                                    |
| LOGHEXP2          | quadrado de LOGHEXP                               |
| LOGEDUC2          | quadrado de LOGEDUC                               |
| LOGED_EX          | LOGHEXP * LOGEDUC                                 |
| GINI              | Coeficiente de Gini de distribuição de renda      |
| TROPICS           | Variável dummy para localização tropical          |
| POPDEN, LOGPOPDEN | densidade populacional                            |
| PUBTHE            | proporção das despesas de saúde que são públicas  |
| GDPC,LOGGDPC      | renda per capita                                  |
| T93,...,T97       | Variáveis dummy de ano                            |
| GEFF              | Medida do Banco Mundial de eficácia do governo    |
| VOICE             | Medida do Banco Mundial de extensão da Democracia |
| OECD              | Variável dummy, membro da OCDE da ONU em 1997     |
| MEANLCMP          | (média de 5 anos) de LOGCMP                       |
| MEANLHC,MEAHLHC2  | média do país e seu quadrado de LOGEDUC           |
| MEANLEXP          | média do país de LOGHEXP                          |

Além do nome e código do país.

```{r load-who}
who <- fread("WHO.csv")
```

```{r panel}
plm_who <- pdata.frame(who, index = c("ID", "YEAR"))

```

a) Quais são as dimensões do painel? É balanceado?

Considere a partir de agora a seguinte regressão para explicar oferta de serviços de saúde

$$LOGCOMP_{it} = \beta_0 + \beta_1 LOGEDUC_{it} + \beta_2 LOGHEXP_{it} + \beta_3 LOGED-EX_{it} + \varepsilon_{it}$$
ou seja, a oferta de saúde é explicada pela educação média e despesas com saúde, incluindo sua interação.

b) Estime a versão agrupada desta especificação e apresente os resultados.

```{r mqo-pool, include=FALSE}
mqo_pool <- plm(LOGCOMP~LOGEDUC*LOGHEXP,
                data = plm_who,
                model = "pooling")
summary(mqo_pool)
```

c) Você não acredita que este modelo esteja capturando a verdadeira influência da educação na oferta de saúde, afinal, os países na amostra são muito diferentes. Discorra sobre quais fatores individuais de cada país podem influenciar no provimento de serviços de saúde. Estes fatores seriam correlacionados com o nível educacional?

d) Escolha um modelo que julgue o mais adequado para estimar o efeito da educação na oferta de saúde, apresente e comente sobre os resultados.

```{r mqo-ocde, include=FALSE}
mqo_fe <- plm(LOGCOMP~LOGEDUC*LOGHEXP,
              data = plm_who,
              model = "within")
summary(mqo_fe)
```

e) Como os resultados do item anterior se comparam a estimação do MQO agrupado? Qual resultado é mais confiável, por quê?

```{r plm-haus, include=FALSE}
phtest(mqo_fe, mqo_pool)
```