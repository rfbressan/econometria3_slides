<!DOCTYPE html>
<html lang="" xml:lang="">
  <head>
    <title>Econometria III</title>
    <meta charset="utf-8" />
    <meta name="author" content="Rafael Bressan" />
    <script src="libs/header-attrs/header-attrs.js"></script>
    <link href="libs/remark-css/default.css" rel="stylesheet" />
    <script src="https://use.fontawesome.com/5235085b15.js"></script>

    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-41584331-6"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'UA-41584331-6');
    </script>

    <link rel="stylesheet" href="../../css/scpo.css" type="text/css" />
    <link rel="stylesheet" href="../../css/scpo-fonts.css" type="text/css" />
  </head>
  <body>
    <textarea id="source">
class: center, middle, inverse, title-slide

.title[
# Econometria III
]
.subtitle[
## Introdu√ß√£o a Causalidade
]
.author[
### Rafael Bressan
]
.date[
### Esag </br> 2023-01-12
]

---


layout: true

&lt;div class="my-footer"&gt;&lt;img src="../../img/logo/UdescEsag.jpeg" style="height: 60px;"/&gt;&lt;/div&gt; 

---



layout: true

&lt;div class="my-footer"&gt;&lt;img src="../../img/logo/UdescEsag.jpeg" style="height: 60px;"/&gt;&lt;/div&gt; 

---

# Introdu√ß√£o a Infer√™ncia Causal

* ***Causalidade*** versus ***Correla√ß√£o***

* _Framework_ de ***Resultados Potenciais*** a.k.a. Modelo Causal de Rubin

* ***Experimentos Aleatorizados*** (Randomized Controlled Trials - RCTs)

* Aplica√ß√£o emp√≠rica. *Tamanho de turma* e *performance do estudante*

---
# Por que Estudar Causalidade?

[![](../../img/photos/the_economist.png)](https://www.economist.com/business/2022/09/07/why-economists-are-flocking-to-silicon-valley)


---
# Por que Estudar Causalidade?

[![](../../img/photos/hbr_economics.png)](https://hbr.org/2019/02/why-tech-companies-hire-so-many-economists)

---

# Causalidade e Economia

- Fazer infer√™ncia causal a partir de dados pode ser visto como a **vantagem comparativa** dos economistas!

- Diversos campos fazem estat√≠stica. Mas poucos treinam seus estudantes para compreender causalidade.

- Conhecimento de infer√™ncia causal √© o que torna economistas √∫teis tanto no setor privado (e.g. empresas de tecnologia) e setor p√∫blico (e.g. avalia√ß√£o de pol√≠ticas p√∫blicas)

--

- Ok, chega de pregar causalidade. üòÖ


---

# O Conceito de Causalidade

__Causalidade__: do que estamos falando? 

- Dizemos que `X` *causa* `Y`

--

  - se n√≥s **intervirmos** no valor de `X` ***sem mudar nada a mais*** ...
  
--

  - ent√£o `Y` tamb√©m mudar√° ***como resultado***.
  
--

- O ponto pricipal √© ***sem mudar nada a mais***, tamb√©m referido por **ceteris paribus (*tudo o mais constante*)**.

--

- ‚ö†Ô∏è Isto ***N√ÉO*** significa que `X` √© o √∫nico fator que causa `Y`.

---

# Correla√ß√£o vs Causalidade

***Correla√ß√£o n√£o √© o mesmo que causalidade*** tornou-se um mantra, mas voc√™ consegue dizer porqu√™?

--

Algumas correla√ß√µes s√£o obviamente esp√∫rias e n√£o tem nada a ver com causa e efeito ([e.g. spurious correlation website](https://www.tylervigen.com/spurious-correlations)).

--

&lt;img src="../../img/photos/spurious.png" width="800px" style="display: block; margin: auto;" /&gt;

---

# Correla√ß√£o vs Causalidade: Fumar e C√¢ncer de Pulm√£o

Mas nem todas as correla√ß√µes s√£o f√°ceis de diferenciar

--

***Fumar causa c√¢ncer de pulm√£o?***

--

.pull-left[
- Hoje em dia, n√≥s sabemos que a resposta √© *SIM*! 

- Mas, voltemos para 1950

  - In√≠cio de um grande aumento no n√∫mero de mortes por c√¢ncer de pulm√£o...
  
  - ... que ocorre ap√≥s um r√°pido aumento no consumo de cigarros
]

--

.pull-right[
&lt;img src="../../img/photos/Smoking_lung_cancer.png" width="400px" style="display: block; margin: auto;" /&gt;
]

--

- √â tentador argumentar que fumar cigarros **causa** c√¢ncer de pulm√£o baseado neste gr√°fico.

---

# Correla√ß√£o vs Causalidade: Fumar e C√¢ncer de Pulm√£o

Na √©poca, muitos eram c√©ticos a esta hip√≥tese, incluindo famosos estat√≠sticos.

--

.pull-left[
***Macro fatores de confus√£o***:  

Outros fatores macro que podem causar c√¢ncer tamb√©m mudaram entre  1900 e 1950:

  - Asfaltamento de estradas,
  
  - Inala√ß√£o de fuma√ßa de motores (vapores de gasolina com chumbo),
  
  - Maior polui√ß√£o atmosf√©rica geral.
]

--

.pull-right[
***Auto sele√ß√£o***:

Fumantes e n√£o fumantes podem ser diferentes em primeiro lugar:
  
   - _Sele√ß√£o de caracter√≠sticas observ√°veis_: idade, escolaridade, renda, etc.
  
   - _Sele√ß√£o de caracter√≠sticas n√£o observ√°veis_: genes (a hipot√©tica teoria do genoma de [Fisher](https://en.wikipedia.org/wiki/Ronald_Aylmer_Fisher)). 
]

---

# Correla√ß√£o vs Causalidade: Outros Exemplos

&gt; Por que a correla√ß√£o observada entre ***anos de estudo*** e ***renda*** n√£o reflete o efeito causal da educa√ß√£o?

--

*Indiv√≠duos que optam por obter mais educa√ß√£o provavelmente diferem daqueles que n√£o: talvez tenham maior habilidade inata, gostem de estudar e sejam bons nisso* `\(\rightarrow\)` ***autossele√ß√£o***

--

&gt; ***Taxa de emprego*** e o n√≠vel do ***sal√°rio m√≠nimo*** n√£o reflete o efeito causal do sal√°rio m√≠nimo?

--

*Aumento de sal√°rio m√≠nimo em momentos em que a taxa de emprego √© alta* `\(\rightarrow\)` ***causalidade reversa / simultaneidade***

--

&gt; ***Crescimento econ√¥mico*** e ***desenvolvimento financeiro*** n√£o reflete o efeito causal do setor financeiro?

--

*Talvez crescimento econ√¥mico leve ao desenvolvimento financeiro e n√£o o contr√°rio* `\(\rightarrow\)` ***causalidade reversa / simultaneidade***

---

# Link com a Teoria Econ√¥mica

* A teoria econ√¥mica nos diz que os indiv√≠duos se comportam para ***maximizar sua utilidade***

* Assim, eles n√£o escolhem agir de ***forma aleat√≥ria*** `\(\rightarrow\)` dizemos que o comportamento do indiv√≠duo √© ***end√≥geno***

* Devemos ser ***suspeitos*** de qualquer correla√ß√£o encontrada nos dados

--

- Como podemos fazer ***reivindica√ß√µes causais*** ent√£o?

- O framework de ***Resultados Potenciais*** ser√° o nosso guia.

---
layout: false
class: title-slide-section-red, middle

# Infer√™ncia Causal

---
layout: true

&lt;div class="my-footer"&gt;&lt;img src="../../img/logo/UdescEsag.jpeg" style="height: 60px;"/&gt;&lt;/div&gt; 

---

# O framework de Resultados Potenciais

Frequentemente chamado de **Modelo Causal de Rubin** em homenagem ao estat√≠stico **Donald Rubin**, que generalizou e formalizou esse modelo na d√©cada de 1970.

--

***Id√©ia-chave***: Cada indiv√≠duo pode ser exposto a **v√°rios estados alternativos de tratamento**.
   - fumar cigarros, fumar charutos ou n√£o fumar,
   - crescendo em um bairro pobre versus um bairro de classe m√©dia versus um bairro rico,
   - estar em uma turma pequena ou grande.
  
--

.pull-left[
Por praticidade, deixe esta vari√°vel de tratamento `\(D_i\)` ser uma vari√°vel bin√°ria:

$$
D_i = \begin{cases} 
                    1 \textrm{ se indiv√≠duo `\(i\)` √© tratado} \\\\ 
                    0 \textrm{ se indiv√≠duo `\(i\)` n√£o √© tratado} 
      \end{cases}
$$
]

--

.pull-right[

***Grupo de tratamento***
todos os indiv√≠duos tais que `\(D_i = 1\)`.

***Grupo de controle***
todos os indiv√≠duos tais que `\(D_i = 0\)`.
]

---


# O framework de Resultados Potenciais

* Nessa estrutura, cada indiv√≠duo tem dois ***resultados potenciais***, mas apenas um ***resultado observado*** `\(Y_i\)`:
  
   - `\(Y_i^1\)`: *resultado potencial se o indiv√≠duo `\(i\)` receber o tratamento*,
  
   - `\(Y_i^0\)`: *resultado potencial se o indiv√≠duo `\(i\)` n√£o receber o tratamento*.

--

* Na vida real, observamos apenas `\(Y_i\)` que pode ser escrito como:

`$$Y_i = D_i \times Y_i^1 + (1- D_i) \times Y_i^0$$`

--

* ***Problema fundamental da infer√™ncia causal***: para qualquer indiv√≠duo `\(i\)`, observamos apenas um dos resultados potenciais [(Holland, 1986)](http://people.umass.edu/~stanek/pdffiles /causal-holland.pdf).
---

# O framework de Resultados Potenciais

* O resultado potencial que n√£o √© observado existe em princ√≠pio, √© chamado de ***resultado contrafactual***.

--

Grupo | `\(Y_i^1\)` | `\(Y_i^0\)`
--------|:---------:|:---------:
Tratamento `\((D_i = 1)\)` &amp;nbsp; &amp;nbsp; | &amp;nbsp; &amp;nbsp; Observ√°vel como `\(Y_i\)` &amp;nbsp; &amp;nbsp; | Contrafactual
Controle `\((D_i = 0)\)` | Contrafactual | &amp;nbsp; &amp;nbsp; Observ√°vel como `\(Y_i\)` &amp;nbsp; &amp;nbsp;

--

* A partir deles podemos definir o ***efeito de tratamento individual*** `\(\delta_i= Y_i^1 - Y_i^0\)`

* `\(\delta_i\)` mede o **efeito causal do tratamento** `\(D_i\)` no resultado `\(Y_i\)` do indiv√≠duo

--

* O efeito do tratamento ***n√£o*** pode ser observado no n√≠vel individual (Por qu√™?), nossos estimandos ser√£o m√©dias populacionais.
---

name: ate

# Efeito M√©dio do Tratamento (ATE)

Efeito m√©dio mais amplo poss√≠vel:

`\begin{align}
ATE &amp;= \mathop{\mathbb{E}}(\delta_i) \\
     &amp;= \mathop{\mathbb{E}}(Y_i^1 - Y_i^0) \\
     &amp;= \mathop{\mathbb{E}}(Y_i^1) - \mathop{\mathbb{E}}(Y_i^0)
\end{align}`
  
* O ATE mede simplesmente a ***m√©dia dos efeitos individuais do tratamento sobre toda a popula√ß√£o***.

([*Ap√™ndice:*](#attandatu) Tratamento M√©dio nos Tratados e Tratamento M√©dio nos N√£o Tratados)
---

# Exemplo: Classe Pequena vs. Grande

Resultados potenciais para os alunos em turma pequena `\((Y^1)\)` ou grande `\((Y^0)\)`:

.pull-left[
Aluno | &amp;nbsp; &amp;nbsp; `\(Y^1\)` &amp;nbsp; &amp;nbsp; | &amp;nbsp; &amp;nbsp; `\(Y^0\)` &amp;nbsp; &amp;nbsp; | &amp;nbsp; &amp;nbsp; `\(\delta\)` &amp;nbsp; &amp;nbsp;
-----------|:---------:|:------:|:---------:|
1 | 5 | 2 | 3
2 | 6 | 4 | 2
3 | 3 | 6 | -3
4 | 5 | 4 | 1
5 | 10 | 8 | 2
6 | 2 | 4 | -2
7 | 5 | 2 | 3
8 | 6 | 4 | 2
M√©dia | 5.25 | 4.25 | 1.0

]

--

.pull-right[

$$
`\begin{align}
\color{#d90502}{\text{ATE}} &amp;= \mathbb{E}(\delta) \\
&amp;=\mathbb{E}(Y^1) - \mathbb{E}(Y^0) \\
&amp;= 5.25 - 4.25 \\
&amp;= 1.0
\end{align}`
$$

- o efeito causal ***m√©dio*** de estar na turma pequena em rela√ß√£o √† grande nas notas √© de 1 ponto.

- ‚ö†Ô∏è nem todos os alunos se beneficiaram igualmente com o tratamento!

]
---

# O problema da Infer√™ncia Causal

* Na pr√°tica, temos o mesmo **problema de falta de dados** para calcular o ATE que tivemos para `\(\delta_i\)`. Falta `\(Y_i^1\)` ou `\(Y_i^0\)` para cada `\(i\)`.

--

* A partir dos dados, podemos calcular a **D**iferen√ßa **S**imples nas m√©dias dos **R**esultados (***DSR***) para ambos os grupos:

$$
`\begin{align}
DSR &amp;= \mathop{\mathbb{E}}(Y_i^1|D_i=1) - \mathop{\mathbb{E}}(Y_i^0|D_i=0) \\
&amp;= \underbrace{\frac{1}{N_T}\sum_{i=1}^{N_T}(Y_i|D_i=1)}_{\text{resultado m√©dio do grupo de tratamento}} - \underbrace{\frac {1}{N_C}\sum_{i=1}^{N_C}(Y_i|D_i=0)}_{\text{resultado m√©dio do grupo de controle}}
\end{align}`
$$

---

# Diferen√ßa Simples nas m√©dias dos Resultados: um exemplo

.pull-left[
Estudante | &amp;nbsp; &amp;nbsp; `\(Y\)` &amp;nbsp; &amp;nbsp; | &amp;nbsp; &amp;nbsp; `\(D\)` &amp;nbsp; &amp;nbsp; | &amp;nbsp; &amp;nbsp; `\(\delta\)`&amp;nbsp; &amp;nbsp;
-----------|:---------:|:---------:|:---------:
1 | 5 | 1 | 3
2 | 6 | 1 | 2
3 | 6 | 0 | -3
4 | 4 | 0 | 1
5 | 10 | 1 | 2
6 | 4 | 0 | -2
7 | 5 | 1 | 3
8 | 6 | 1 | 2

]

.pull-right[
A diferen√ßa simples na m√©dia dos resultados:

$$
`\begin{align}
DSR &amp;= \frac{5+6+10+5+6}{5} - \frac{6+4+4}{3} \\
&amp;\approx 6.4 - 4.67 \approx 1.73
\end{align}`
$$

* A DSR √© bem maior que o ATE!

* A DSR **ir√° (quase sempre) falhar em capturar o efeito causal do tratamento**

* Observe que esse tipo de compara√ß√£o "ing√™nua" √© frequentemente feita por jornalistas, pol√≠ticos, cientistas mal treinados (mas voc√™ n√£o mais! üòâ)
]

---

name: naive_comp

# Problemas com compara√ß√µes ing√™nuas

Reescrever a DSR para fazer o efeito de tratamento individual `\((\delta_i)\)` aparecer na equa√ß√£o.

$$
`\begin{align}
   DSR &amp;= \mathop{\mathbb{E}}(Y_i^1|D_i=1) - \mathop{\mathbb{E}}(Y_i^0|D_i=0) \\ &amp;= \mathop{\mathbb{ E}}(Y_i^0 + \delta_i | D_i = 1) - \mathop{\mathbb{E}}(Y_i^0 | D_i = 0)
\end{align}`
$$
--

Para simplificar, suponha que o **efeito do tratamento seja constante** entre as pessoas: para todo `\(i, \delta_i = \delta\)`.

--

`$$DSR = \delta + \underbrace{\mathop{\mathbb{E}}(Y_i^0 | D_i = 1) - \mathop{\mathbb{E}}(Y_i^0 | D_i = 0)}_\text{Vi√©s de Sele√ß√£o}$$`

E por hip√≥tese: `\(ATE = \mathop{\mathbb{E}}(\delta_i) = \mathop{\mathbb{E}}(\delta) = \delta\)` 


([*Ap√™ndice*](#naive_comp_extended): quando a suposi√ß√£o de tratamento constante √© relaxada, outro termo de vi√©s aparece.)
---

# Aleatoriza√ß√£o resolve o problema da infer√™ncia causal!

* ***Experimentos aleatorizados***: voc√™ atribui ***aleatoriamente*** pessoas a um tratamento e a um grupo de controle.

* Nesse caso, a atribui√ß√£o do tratamento √© **independente** dos resultados potenciais. 

--

* Em particular, n√£o h√° raz√£o para `\(\mathop{\mathbb{E}}(Y_i^0 | D_i = 1)\)` ser diferente de `\(\mathop{\mathbb{E}}(Y_i^0 | D_i = 0)\)`

   * Portanto, o ***vi√©s de sele√ß√£o √© igual a 0***.

--

* Com atribui√ß√£o aleat√≥ria, temos:

$$ DSR = \mathop{\mathbb{E}}(Y_i^1|D_i=1) - \mathop{\mathbb{E}}(Y_i^0|D_i=0) = ATE$$

üëâ Podemos estimar o ATE diretamente a partir dos dados!
---

layout: false
class: title-slide-section-red, middle

# Experimentos Aleatorizados

---
layout: true

&lt;div class="my-footer"&gt;&lt;img src="../../img/logo/UdescEsag.jpeg" style="height: 60px;"/&gt;&lt;/div&gt; 

---

# Experimentos Aleatorizados

- Frequentemente chamados de **R**andomized **C**ontrolled **T**rials (RCT).

- Os primeiros RCTs foram realizados h√° muito tempo (s√©culos XVIII e XIX), principalmente em **Medicina**.

- No in√≠cio do s√©culo XX foram popularizados por estat√≠sticos famosos como **J. Neyman** ou **R.A. Fisher**.

- Desde ent√£o, eles tiveram uma influ√™ncia crescente e se tornaram progressivamente uma confi√°vel [ferramenta para avalia√ß√£o de pol√≠ticas p√∫blicas](https://www.povertyactionlab.org/fr).

- Quanto √† economia, o **Pr√™mio Nobel de Economia de 2019** foi concedido a tr√™s expoentes dos RCTs, [Abhijit Banerjee, Esther Duflo e Michael Kremer](https://www.economist.com/finance-and-economics/ 2019/10/17/a-nobel-economics-pr√™mio-vai-para-pioneiros-na-compreens√£o-da-pobreza), "por sua abordagem experimental para aliviar a pobreza global".
---

# Tamanho da turma e desempenho dos alunos

Suponha que regredimos as notas m√©dias dos alunos em matem√°tica ou leitura no tamanho da turma.

`$$\textrm{matem√°tica}_i = b_0 + b_1 \textrm{tamanho}_i + e_i$$`

Sem maiores informa√ß√µes sobre a origem dos dados coletados, `\(b_1^{OLS}\)` s√≥ poder√° estabelecer uma ***associa√ß√£o*** e n√£o uma ***rela√ß√£o causal***.

--

* **Sele√ß√£o de alunos**: sele√ß√£o em escolas com turmas de tamanhos diferentes. Pais tenham a no√ß√£o de que turmas menores s√£o melhores, eles colocar√£o seus filhos nessas escolas.

--

* **Sele√ß√£o de professores**: os professores escolhem escolas com turmas menores porque √© mais f√°cil ensinar nestas e, se houver competi√ß√£o, os professores melhores ter√£o as vagas.

--

Um RCT cuidaria de todos esses vieses!
---

# O Experimento do Projeto STAR

Tennessee **S**student/**T**eacher **A**chievement **R**atio Experiment (ver [Krueger (1999)](http://piketty.pse.ens.fr/files/Krueger1999.pdf))

* Financiado pela legislatura do Tennesse por um custo total de aprox. $ 12 milh√µes.

* A experi√™ncia come√ßou no ano letivo de 1985-1986 e durou quatro anos.

--

* 11.600 alunos e professores foram **distribu√≠dos aleatoriamente** para um dos 3 grupos a seguir, do jardim de inf√¢ncia at√© a terceira s√©rie:

   1. ***Turma pequena***: 13-17 alunos por professor,
  
   2. ***Aula regular***: 22-25 alunos,
  
   3. ***Classe regular/auxiliar***: 22-25 alunos com um *auxiliar* do professor em tempo integral.

---
# O Experimento do Projeto STAR

* A aleatoriza√ß√£o ocorreu dentro das escolas.

* As habilidades de matem√°tica e leitura dos alunos foram testadas por volta de mar√ßo de cada ano.

--

* Houve um problema de ***atrito n√£o aleat√≥rio***, mas vamos ignor√°-lo.

---

class:inverse

# Tarefa: Dados STAR (usando R)

1. Carregue os dados *STAR*  [daqui](https://www.dropbox.com/s/bf1fog8yasw3wjj/star_data.csv?dl=1) e atribua-os a um objeto chamado `star_df`. Leia a ajuda para os dados [aqui](https://rdrr.io/cran/AER/man/STAR.html) para entender a que correspondem as vari√°veis. (Observa√ß√£o: os dados foram *reformulados*, portanto, n√£o se preocupe com o "k", "1" etc. nos nomes das vari√°veis na ajuda.)

1. Qual √© a unidade de observa√ß√£o? Qual vari√°vel cont√©m: (i) a designa√ß√£o (aleat√≥ria) da turma, (ii) a nota do aluno na turma, (iii) os resultados de interesse?

1. Quantas observa√ß√µes existem? Por que tantas se 11.598 alunos participaram? Por que existem tantos 'NA's? A que eles correspondem?

1. Mantenha apenas os casos sem `NA`s com o seguinte c√≥digo:
`star_df &lt;- star_df[complete.cases(star_df),]`

1. Vamos verificar o qu√£o bem a aleatoriza√ß√£o foi feita fazendo ***verifica√ß√µes de balanceamento***.
Calcule a porcentagem m√©dia de meninas, afro-americanos e alunos com almo√ßo gratuito por s√©rie *e* classe de tratamento. 

---
# Tarefa: Dados STAR (usando R)


```r
star_df = readr::read_csv(file = "https://www.dropbox.com/s/bf1fog8yasw3wjj/star_data.csv?dl=1")
star_df &lt;- star_df[complete.cases(star_df),]

star_df |&gt; 
    group_by(grade, star) |&gt; 
    summarise(girls = sum(gender == "female")/n())
```

```
## # A tibble: 12 √ó 3
## # Groups:   grade [4]
##    grade star         girls
##    &lt;chr&gt; &lt;chr&gt;        &lt;dbl&gt;
##  1 1     regular      0.487
##  2 1     regular+aide 0.478
##  3 1     small        0.486
##  4 2     regular      0.483
##  5 2     regular+aide 0.477
##  6 2     small        0.491
##  7 3     regular      0.489
##  8 3     regular+aide 0.472
##  9 3     small        0.501
## 10 k     regular      0.485
## 11 k     regular+aide 0.488
## 12 k     small        0.480
```

---

# O Experimento do Projeto STAR

Acabamos de ver que em um RCT o Efeito M√©dio do Tratamento √© obtido computando as diferen√ßas nos resultados entre os grupos de tratamento e controle.

Vamos nos concentrar apenas em:

- Um grupo de tratamento: **pequenas turmas**,

- Um grupo de controle: **aulas regulares**,

- Uma s√©rie: **jardim de inf√¢ncia** (k).
--



s√©rie | teste | m√©dia regular | m√©dia pequena | ATE
--------|---------|:---------:|:---------:|:---------:
k | matem√°tica | 484.45 | 493.34 | 8.9
k | leitura | 435.76 | 441.13 | 5.37

Qual √© a interpreta√ß√£o para esses ATEs?

---

# RCT em forma de Regress√£o

$$ Y_i = D_i Y_i^1 + (1 - D_i) Y_i^0 $$

--

Fatorando por `\(D_i\)` e substituindo `\(Y_i^1 - Y_i^0\)` por `\(\delta_i\)`, obtemos:

`$$\begin{align} Y_i &amp;=Y_i^0 +D_i (Y_i^1 - Y_i^0) \\ &amp;= Y_i^0 +D_i \delta_i \end{align}$$`

--

Assumindo `\(\delta_i = \delta\)`, para todo `\(i\)`, ent√£o `\(Y_i = Y_i^0 + D_i \delta\)`

--

Adicionando `\(\mathbb{E}[Y_i^0] - \mathbb{E}[Y_i^0] = 0\)` ao lado direito:

`$$\begin{align} Y_i &amp;= \mathbb{E}[Y_i^0] + D_i \delta + Y_i^0 - \mathbb{E}[Y_i^0] \\ &amp;= b_0 + \delta D_i + e_i \end{align}$$`
onde `\(b_0 = \mathbb{E}[Y_i^0]\)` e `\(e_i = Y_i^0 - \mathbb{E}[Y_i^0]\)`

---

# O Experimento do Projeto STAR: Regress√£o

A √∫ltima equa√ß√£o se parece exatamente com o modelo de regress√£o simples! (com `\(\delta = b_1\)`)

Vamos, portanto, estimar o ATE de ser designado para uma turma pequena em notas de matem√°tica.

--

Queremos estimar o seguinte modelo: `\(\text{math score}_i = b_0 + \delta \text{small}_i + e_i\)`, com

$$
\text{pequeno}_i = \begin{cases}
                     1 \textrm{ se atribu√≠do a uma turma pequena} \\\\
                     0 \textrm{ se atribu√≠do a uma turma regular}
       \end{cases}
$$
.pull-left[

```r
star_df_k_small &lt;- star_df %&gt;%
    filter(star %in% c("regular", "small") &amp;
           grade == "k") %&gt;% 
  mutate(small = (star == "small"))
```

]

.pull-left[

```r
star_df_k_small %&gt;%
  count(star, grade)
```

```
## # A tibble: 2 √ó 3
##   star    grade     n
##   &lt;chr&gt;   &lt;chr&gt; &lt;int&gt;
## 1 regular k      1781
## 2 small   k      1578
```
]

---

# O Experimento do Projeto STAR: Regress√£o

Modelo de regress√£o que queremos estimar: `\(\text{math score}_i = b_0 + \delta \text{small}_i + e_i\)`


```r
lm(math ~ small, star_df_k_small)
```

```
## 
## Call:
## lm(formula = math ~ small, data = star_df_k_small)
## 
## Coefficients:
## (Intercept)    smallTRUE  
##     484.446        8.895
```

--

Lembre-se de que: `\(b_0 = \mathbb{E}[Y_i^0]\)` e `\(\delta = \mathbb{E}[Y_i | D_i = 1] - \mathbb{E}[Y_i | D_i = 0]\)`

.pull-left[

```r
b_0 = mean(star_df_k_small$math[
    star_df_k_small$small == FALSE])
b_0
```

```
## [1] 484.4464
```
]

.pull-right[

```r
delta = mean(star_df_k_small$math[
    star_df_k_small$small == TRUE]) - 
  mean(star_df_k_small$math[
    star_df_k_small$small == FALSE])
delta
```

```
## [1] 8.895193
```
]

---

# Regress√£o com uma Vari√°vel Dummy: Graficamente

O regressor em nossa regress√£o √© uma ***vari√°vel bin√°ria***, ou seja, uma vari√°vel que assume os valores VERDADEIRO ou FALSO (1 ou 0).

&lt;img src="01-causality_pt_files/figure-html/unnamed-chunk-10-1.svg" style="display: block; margin: auto;" /&gt;

---

# Regress√£o com uma Vari√°vel Dummy: Graficamente

O regressor em nossa regress√£o √© uma ***vari√°vel bin√°ria***, ou seja, uma vari√°vel que assume os valores VERDADEIRO ou FALSO (1 ou 0).

&lt;img src="01-causality_pt_files/figure-html/unnamed-chunk-11-1.svg" style="display: block; margin: auto;" /&gt;

---

# Regress√£o com uma Vari√°vel Dummy: Graficamente

O regressor em nossa regress√£o √© uma ***vari√°vel bin√°ria***, ou seja, uma vari√°vel que assume os valores VERDADEIRO ou FALSO (1 ou 0).

&lt;img src="01-causality_pt_files/figure-html/unnamed-chunk-12-1.svg" style="display: block; margin: auto;" /&gt;


---

# Regress√£o com uma Vari√°vel Dummy: Graficamente

O regressor em nossa regress√£o √© uma ***vari√°vel bin√°ria***, ou seja, uma vari√°vel que assume os valores VERDADEIRO ou FALSO (1 ou 0).

&lt;img src="01-causality_pt_files/figure-html/unnamed-chunk-13-1.svg" style="display: block; margin: auto;" /&gt;

---

# Regress√£o com uma Vari√°vel Dummy: Formalmente

Lembre-se do modelo de regress√£o: `\(\text{math score}_i = b_0 + \delta \text{small}_i + e_i\)`

`\(\begin{align} \mathbb{E}[\textrm{math score} | \text{small}_i = 0]&amp;= \mathbb{E}[b_0 + \delta \text{small}_i + e_i | \text{small}_i = 0] \\ &amp;= b_0 + \delta \mathbb{E}[\text{small}_i| \text{small}_i = 0] + \mathbb{E}[e_i|\text{small}_i = 0] \\ &amp;= b_0 \end{align}\)`

--

`\(\begin{align} \mathbb{E}[\textrm{math score} | \text{small}_i = 1]&amp;= \mathbb{E}[b_0 + \delta \text{small}_i + e_i | \text{small}_i = 1] \\ &amp;= b_0 + \delta \mathbb{E}[\text{small}_i| \text{small}_i = 1] + \mathbb{E}[e_i|\text{small}_i = 1] \\ &amp;= b_0 + \delta \end{align}\)`

--

`\(\begin{align} ATE &amp;= \mathbb{E}[\textrm{math score} | \text{small}_i = 1] - \mathbb{E}[\textrm{math score} | \text{small}_i = 0] \\ &amp;= b_0 + \delta - b_0 \\ &amp;= \delta \end{align}\)`

--

J√° sab√≠amos disso, mas agora entendemos por que isso √© verdade ‚úåÔ∏è

---

class:inverse

# Tarefa: Sua Vez!


Execute o c√≥digo a seguir para filtrar o conjunto de dados para manter apenas os alunos da primeira s√©rie e os grupos de turmas pequenas e regulares:


```r
star_df_clean &lt;- star_df %&gt;%
    filter(grade == "1" &amp; star %in% c("small", "regular"))
```

1. Calcule a pontua√ß√£o m√©dia em matem√°tica para ambos os grupos e a diferen√ßa entre os dois.

1. Crie uma vari√°vel bin√°ria `tratamento` igual a `VERDADEIRO` se o aluno estiver no grupo de tratamento (ou seja, turma pequena) e `FALSO` se no grupo de controle (ou seja, turma de tamanho normal). *Dica:* voc√™ pode criar a vari√°vel bin√°ria com `tratamento = (star == "small")`.

1. Fa√ßa a regress√£o da pontua√ß√£o em matem√°tica na vari√°vel simulada de tratamento. Os resultados est√£o de acordo com a quest√£o 2?

1. Como voc√™ interpreta esses coeficientes?
---

# Defici√™ncias dos RCTs

Os RCTs t√™m uma ***validade interna*** muito forte, ou seja, eles podem estabelecer v√≠nculos causais de forma convincente.

No entanto, eles t√™m algumas defici√™ncias:

   * RCTs s√£o **caros**,
   * RCTs podem enfrentar alguns **problemas √©ticos**: alguns *tratamentos* simplesmente n√£o podem ser administrados √†s pessoas,
   * Os RCTs levam tempo e podemos ter **limita√ß√£o de tempo**.

--

* **Interpreta√ß√£o** dos resultados:

   * ***Validade externa***: Resultados de um determinado RCT podem ser generalizados para outros contextos?
  
   * Desvendar os mecanismos que est√£o atuando pode ser dif√≠cil,
  
   * Aleatoriza√ß√£o imperfeita, atrito, etc.
---


# O que vem depois?

* Portanto, se n√£o podemos administrar um RCT, isso significa que temos que encontrar uma maneira de fazer infer√™ncia causal a partir de ***dados observacionais*** (em oposi√ß√£o a ***dados experimentais***).

--

2 casos amplos:

* ***sele√ß√£o ocorre em caracter√≠sticas observ√°veis***: *regress√£o m√∫ltipla*

* ***sele√ß√£o ocorre em caracter√≠sticas n√£o observ√°veis***: m√∫ltiplas abordagens (e.g., *vari√°veis instrumentais*, *diferen√ßa em diferen√ßas*, etc.)

---

&lt;br&gt;
&lt;br&gt;

.center[
&lt;img src="../../img/photos/correlation_funny.png" width="1000px" style="display: block; margin: auto;" /&gt;
]

---

# Leitura Recomendada

* CUNNINGHAM, Scott. Causal Inference: The Mixtape, New Haven: Yale University Press, 2021. URL: https://mixtape.scunning.com/

* ANGRIST, Joshua D.; PISCHKE, J√∂rn-Steffen. Mastering'metrics: The path from cause to effect. Princeton university press, 2014. URL: http://www.masteringmetrics.com/

* ANGRIST, Joshua D.; PISCHKE, J√∂rn-Steffen. Mostly harmless econometrics: An empiricist's companion. Princeton university press, 2009.

---
layout: false

class: title-slide-final, middle
background-image: url(../../img/logo/UdescEsag.jpeg)
background-size: 350px
background-position: 9% 19%

# AT√â A PR√ìXIMA AULA!




|                                                                                                            |                                   |
| :--------------------------------------------------------------------------------------------------------- | :-------------------------------- |
| &lt;a href="https://github.com/rfbressan/econometria3_slides"&gt;.ScPored[&lt;i class="fa fa-link fa-fw"&gt;&lt;/i&gt;] | Slides |
| &lt;a href="http://github.com/rfbressan"&gt;.ScPored[&lt;i class="fa fa-github fa-fw"&gt;&lt;/i&gt;]                          | @rfbressan                      |


.footnote[
[1]: Este slides foram baseados nas aulas de econometria da [SciencesPo Department of Economics](https://github.com/ScPoEcon/ScPoEconometrics-Slides)
]
---

layout: false
class: title-slide-section-red, middle

# Appendix

---

layout: true

&lt;div class="my-footer"&gt;&lt;img src="../img/logo/ScPo-shield.png" style="height: 60px;"/&gt;&lt;/div&gt; 

---

name: attandatu

# Average Treatment on the Treated and on the Untreated

Other ***conditional*** average treatment effects may be of interest:

.pull-left[
**A**verage **T**reatment on the **T**reated (***ATT***)

`\begin{align}
 ATT &amp;= \mathop{\mathbb{E}}(\delta_i | D_i = 1) \\
     &amp;= \mathop{\mathbb{E}}(Y_i^1 - Y_i^0 | D_i = 1) \\
     &amp;= \mathop{\mathbb{E}}(Y_i^1 | D_i = 1) - \mathop{\mathbb{E}}(Y_i^0 | D_i = 1)
\end{align}`

The ATT measures the ***average treatment effect conditional on being in the treatment group***.

*Example:* the effect of participating in a training program (*treatment*) for those who participated (*treatment group*).
]

.pull-right[
**A**verage **T**reatment on the **U**ntreated (***ATU***)

`\begin{align}
 ATU &amp;= \mathop{\mathbb{E}}(\delta_i | D_i = 0) \\
     &amp;= \mathop{\mathbb{E}}(Y_i^1 - Y_i^0 | D_i = 0) \\
     &amp;= \mathop{\mathbb{E}}(Y_i^1 | D_i = 0) - \mathop{\mathbb{E}}(Y_i^0 | D_i = 0)
\end{align}`

The ATU measures the ***average treatment effect conditional on being in the control group***.

*Example:* the effect of attending a private school (*treatment*) for students from a public school (*control group*).
]

*Note:* In the majority of cases, ATE `\(\neq\)` ATT `\(\neq\)` ATU! &lt;span&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;/span&gt; [*back*](#ate)

---

name: naive_comp_extended

# Problems with Naive Comparisons

Let's now relax the assumption that the treatment effect is constant among all individuals.

After [some tedious calculations](https://mixtape.scunning.com/potential-outcomes.html#simple-difference-in-means-decomposition) that we skip, the SDO can now be decomposed as: 

`\begin{align}
  SDO &amp;= ATE + \underbrace{\mathop{\mathbb{E}}(Y_i^0 | D_i = 1) - \mathop{\mathbb{E}}(Y_i^0 | D_i = 0)}_\text{Selection bias} \\
  &amp; \quad \quad  \quad \quad + \underbrace{(1-\pi)(ATT - ATU)}_\text{Heterogenous treatment effect bias}
\end{align}`

where `\(1 - \pi\)` denotes the share of people in the control group.

So there is a novel source of bias that comes from the potential ***heterogeneity in the individual treatment effect*** `\(\delta_i\)`.

* ***Selection bias***: those who attend university are likely to have higher baseline cognitive skills (regardless of whether they actually attend college).
* ***Heterogeneous treatment effect bias***: those who attend university may improve their cognitive skills more at university because they are more motivated. &lt;span&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;/span&gt; [back](#naive_comp)
    </textarea>
<style data-target="print-only">@media screen {.remark-slide-container{display:block;}.remark-slide-scaler{box-shadow:none;}}</style>
<script src="https://cdnjs.cloudflare.com/ajax/libs/remark/0.14.0/remark.min.js"></script>
<script src="../../js/ru_xaringan.js"></script>
<script>var slideshow = remark.create({
"highlightStyle": "github",
"highlightLines": true,
"countIncrementalSlides": false,
"ratio": "16:9"
});
if (window.HTMLWidgets) slideshow.on('afterShowSlide', function (slide) {
  window.dispatchEvent(new Event('resize'));
});
(function(d) {
  var s = d.createElement("style"), r = d.querySelector(".remark-slide-scaler");
  if (!r) return;
  s.type = "text/css"; s.innerHTML = "@page {size: " + r.style.width + " " + r.style.height +"; }";
  d.head.appendChild(s);
})(document);

(function(d) {
  var el = d.getElementsByClassName("remark-slides-area");
  if (!el) return;
  var slide, slides = slideshow.getSlides(), els = el[0].children;
  for (var i = 1; i < slides.length; i++) {
    slide = slides[i];
    if (slide.properties.continued === "true" || slide.properties.count === "false") {
      els[i - 1].className += ' has-continuation';
    }
  }
  var s = d.createElement("style");
  s.type = "text/css"; s.innerHTML = "@media print { .has-continuation { display: none; } }";
  d.head.appendChild(s);
})(document);
// delete the temporary CSS (for displaying all slides initially) when the user
// starts to view slides
(function() {
  var deleted = false;
  slideshow.on('beforeShowSlide', function(slide) {
    if (deleted) return;
    var sheets = document.styleSheets, node;
    for (var i = 0; i < sheets.length; i++) {
      node = sheets[i].ownerNode;
      if (node.dataset["target"] !== "print-only") continue;
      node.parentNode.removeChild(node);
    }
    deleted = true;
  });
})();
// add `data-at-shortcutkeys` attribute to <body> to resolve conflicts with JAWS
// screen reader (see PR #262)
(function(d) {
  let res = {};
  d.querySelectorAll('.remark-help-content table tr').forEach(tr => {
    const t = tr.querySelector('td:nth-child(2)').innerText;
    tr.querySelectorAll('td:first-child .key').forEach(key => {
      const k = key.innerText;
      if (/^[a-z]$/.test(k)) res[k] = t;  // must be a single letter (key)
    });
  });
  d.body.setAttribute('data-at-shortcutkeys', JSON.stringify(res));
})(document);
(function() {
  "use strict"
  // Replace <script> tags in slides area to make them executable
  var scripts = document.querySelectorAll(
    '.remark-slides-area .remark-slide-container script'
  );
  if (!scripts.length) return;
  for (var i = 0; i < scripts.length; i++) {
    var s = document.createElement('script');
    var code = document.createTextNode(scripts[i].textContent);
    s.appendChild(code);
    var scriptAttrs = scripts[i].attributes;
    for (var j = 0; j < scriptAttrs.length; j++) {
      s.setAttribute(scriptAttrs[j].name, scriptAttrs[j].value);
    }
    scripts[i].parentElement.replaceChild(s, scripts[i]);
  }
})();
(function() {
  var links = document.getElementsByTagName('a');
  for (var i = 0; i < links.length; i++) {
    if (/^(https?:)?\/\//.test(links[i].getAttribute('href'))) {
      links[i].target = '_blank';
    }
  }
})();
// adds .remark-code-has-line-highlighted class to <pre> parent elements
// of code chunks containing highlighted lines with class .remark-code-line-highlighted
(function(d) {
  const hlines = d.querySelectorAll('.remark-code-line-highlighted');
  const preParents = [];
  const findPreParent = function(line, p = 0) {
    if (p > 1) return null; // traverse up no further than grandparent
    const el = line.parentElement;
    return el.tagName === "PRE" ? el : findPreParent(el, ++p);
  };

  for (let line of hlines) {
    let pre = findPreParent(line);
    if (pre && !preParents.includes(pre)) preParents.push(pre);
  }
  preParents.forEach(p => p.classList.add("remark-code-has-line-highlighted"));
})(document);</script>

<script>
slideshow._releaseMath = function(el) {
  var i, text, code, codes = el.getElementsByTagName('code');
  for (i = 0; i < codes.length;) {
    code = codes[i];
    if (code.parentNode.tagName !== 'PRE' && code.childElementCount === 0) {
      text = code.textContent;
      if (/^\\\((.|\s)+\\\)$/.test(text) || /^\\\[(.|\s)+\\\]$/.test(text) ||
          /^\$\$(.|\s)+\$\$$/.test(text) ||
          /^\\begin\{([^}]+)\}(.|\s)+\\end\{[^}]+\}$/.test(text)) {
        code.outerHTML = code.innerHTML;  // remove <code></code>
        continue;
      }
    }
    i++;
  }
};
slideshow._releaseMath(document);
</script>
<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
(function () {
  var script = document.createElement('script');
  script.type = 'text/javascript';
  script.src  = 'https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-MML-AM_CHTML';
  if (location.protocol !== 'file:' && /^https?:/.test(script.src))
    script.src  = script.src.replace(/^https?:/, '');
  document.getElementsByTagName('head')[0].appendChild(script);
})();
</script>
  </body>
</html>
