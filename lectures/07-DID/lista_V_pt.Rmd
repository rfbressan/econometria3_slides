---
title: "Diferenças em diferenças"
subtitle: "Lista de Exercícios V"
author: "Rafael Bressan"
date: "UDESC/Esag </br> Data devida: 09/12/2022"
output: html_document
params:
    solutions: false
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


## Questão 1

Considere a configuração canônica do DID com T = 2 e N = 2.

$$y_{it} = \beta_0 + \beta_1 State_i + \beta_2 Post_t + \theta D_{it} + \varepsilon_{it}$$

suponha que a variável de tempo seja omitida. Assim, a equação de estimativa é

$$y_{it} = \beta_0 + \beta_1 State_i + \theta D_{it} + \varepsilon_{it}$$

onde $D_{it}= State_i \cdot Time_t$ é o indicador de tratamento.

(a) Encontre uma expressão algébrica para o estimador de mínimos quadrados $\hat\theta$.

(b) Mostre que em termos populacionais $\theta$ é função apenas da subamostra tratada e não da subamostra não tratada.

(c) $\theta$ é um estimador de diferença-em-diferenças?

(d) Sob quais premissas $\theta$ pode ser um estimador apropriado do efeito do tratamento?

## Questão 2

Em 1980, o estado do Kentucky elevou o limite de renda semanal que era coberta pela compensação em caso de acidentes. Queremos saber se essa nova política fez com que os trabalhadores passassem mais tempo desempregados. Se os benefícios não forem generosos o suficiente, os trabalhadores podem processar as empresas por lesões no trabalho, enquanto benefícios excessivamente generosos podem causar problemas de risco moral e induzir os trabalhadores a serem mais imprudentes no trabalho ou alegar que lesões fora do trabalho ocorreram durante o trabalho.

a) Vamos utilizar dados de lesões no ambiente de trabalho oriundo do artigo de Meyer e Viscusi (1995). Carrege os dados a partir do arquivo `injury.csv`. 

```{r, echo=FALSE, message=FALSE, warning=FALSE}
library(ggplot2)
library(readr)
library(dplyr)

injury <- read_csv("data/injury.csv")
```

b) Estas são as principais colunas com as quais nos preocuparemos:

* durat (que vamos renomear para duration): duração dos benefícios de desemprego, medida em semanas

* ldurat (que vamos renomear para log_duration): Versão registrada de durat (log(durat))

* afchnge (que vamos renomear para after_1980): variável indicadora que marca se a observação aconteceu antes (0) ou depois (1) da mudança de política em 1980

* highearn: variável indicadora que marca se a observação é de baixo (0) ou alto (1) salário

Filtre as observações para abrangirem somente o estado de Kentucky (`ky == 1`) e renomeie as váriaveis de acordo.

```{r, echo=FALSE}
inj_df <- injury |> 
    filter(ky == 1) |> 
    rename(duration = durat,
           log_duration = ldurat,
           after_1980 = afchnge)
```

c) Em um gráfico separado entre antes e depois salário plote a média e o intervalo de confiança da duração do desemprego em logarítimo para os trabalhadores de baixo (controle) e alto salário (tratamento). Com base neste gráfico, você espera que o efeito da política sobre o tempo de desemprego seja positivo ou negativo?

```{r, echo=FALSE, include=FALSE}
ggplot(inj_df, aes(x = factor(highearn), y = log_duration)) +
  stat_summary(geom = "pointrange", size = 1, color = "red",
               fun.data = "mean_se", fun.args = list(mult = 1.96)) +
  facet_wrap(vars(after_1980))

```

d) Considere que $t\in\{0,1\}$ represente antes/depois da política e $g\in\{T, C\}$ os grupos tratamento e controle, respectivamente. Calcule a estimativa de DID a partir da seguinte expressão:

$$
\hat\delta = 
\left(\mathbb{E}[Y_{gt}|g=T, t=1] - \mathbb{E}[Y_{gt}|g=T, t=0]\right) - \left(\mathbb{E}[Y_{gt}|g=C, t=1] - \mathbb{E}[Y_{gt}|g=C, t=0]\right) 
$$

```{r, echo=FALSE, message=FALSE, include=FALSE}
diffs <- inj_df %>% 
  group_by(after_1980, highearn) %>% 
  summarize(mean_duration = mean(log_duration),
            # Calculate average with regular duration too, just for fun
            mean_duration_for_humans = mean(duration))
(diffs$mean_duration[4] - diffs$mean_duration[3]) - (diffs$mean_duration[2]-diffs$mean_duration[1])
```

e) O cálculo manual feito no item anterior, apesar de correto, não nos fornece erro-padrão associado a estimativa e portanto, não conseguimos fazer inferência. O modelo de regressão para DID é útil nestas situações. Escreva a equação de regressão e estime-a. O efeito encontrado é o mesmo do item anterior? E quanto a inferência estatística, este efeito é estatisticamente significativo?

```{r, echo=FALSE, include=FALSE}
reg <- lm(log_duration~highearn*after_1980, data = inj_df)
summary(reg)
```


## Questão 3

Este exercício analisa o impacto de um programa de subsídio de plano de saúde para os pobres, o HISP. Um dos principais objetivos do programa é reduzir a carga de despesas relacionadas à saúde para famílias de baixa renda. Você foi encarregado de conduzir uma avaliação de impacto do efeito do HISP sobre os gastos diretos com saúde. Você usará o conjunto de dados denominado “evaluation.dta” para conduzir sua análise.

Nesse cenário, você estimará o efeito do programa comparando a mudança nos resultados ao longo do tempo para um grupo de famílias que se inscreveram no programa. Assuma cumprimento integral, o que significa que todos os domicílios elegíveis ao programa se inscreveram nele.

a)  Compare os gastos médios com saúde (health_expenditures) antes (round = 0) e após o programa (round = 1) para o grupo de domicílios elegíveis (eligible =1) nas comunidades de tratamento (treatment_locality = 1).

```{r, echo=FALSE, message=FALSE, warning=FALSE, include=FALSE}
library(haven)
eval_df <- read_dta("data/evaluation.dta")
# Apenas comunidades de tratamento
eval_df <- eval_df |> 
    filter(treatment_locality == 1)


diffs4 <- eval_df |> 
    group_by(round, eligible) |> 
    summarise(health_exp = mean(health_expenditures, na.rm = TRUE))
(diffs4$health_exp[4] - diffs4$health_exp[3]) - (diffs4$health_exp[2] - diffs4$health_exp[1])
```

b) Estime o mesmo resultado utilizando um modelo de regressão.

```{r, echo=FALSE, include=FALSE}
reg4 <- lm(health_expenditures~round*eligible, data = eval_df)
summary(reg4)
```

c) A regressão linear de efeitos fixos em duas vias (TWFE) tornou-se um método padrão para estimar efeitos causais a partir de dados em painel, pois, ela pode controlar para fatores não observados da unidade e do tempo ao mesmo tempo. Outra justificativa comum para o uso do estimador TWFE é baseada em sua equivalência ao estimador de DID na configuração mais simples com dois grupos e dois períodos de tempo. A especificação TWFE é:

$$
y_{it}=\alpha_i+\gamma_t+\delta D_{it}+\varepsilon_{it}
$$
onde $D_{it}$ é uma variável binária que representa o status de tratamento (1, somente se for do grupo tratado no período pós). Neste caso $i$ representa o domicílio e $t$ o período. Note que essa especificação é mais geral que o DID canônico, uma vez que o efeito fixo de unidade, $\alpha_i$ engloba (absorve) o próprio indicador de grupo de tratamento.

Rode uma regressão de TWFE para encontrar o mesmo efeito causal dos itens anteriores.

**ATENÇÃO:** a equivalência TWFE e DID só vale para o caso 2x2. Caso tenhamos mais de dois períodos, com adesão ao tratamento em momentos diferentes, ou efeitos heterogêneos entre as coortes, a equivalência deixa de existir. Uma recente literatura vem mostrando o viés da estimação via TWFE nestes casos, (Goodman-Bacon, 2021; Callaway e Sant'anna, 2021; De Chaisemartin e D'Haultfœuille, 2020; Imai e Kim, 2021; Sun e Abraham, 2021) 

```{r, echo=FALSE, include=FALSE}
library(fixest)
reg4_twfe <- feols(health_expenditures~i(round, eligible, ref = 0)|household_identifier+round,
                   data = eval_df)
summary(reg4_twfe)
```

# Referências {-}

B.D. Meyer, W.K. Viscusi, and D.L. Durbin (1995), “Workers’ Compensation and Injury Duration: Evidence from a Natural Experiment”, American Economic Review 85, 322-340.

CALLAWAY, Brantly; SANT’ANNA, Pedro HC. Difference-in-differences with multiple time periods. Journal of Econometrics, v. 225, n. 2, p. 200-230, 2021.

DE CHAISEMARTIN, Clément; D'HAULTFOEUILLE, Xavier. Two-way fixed effects estimators with heterogeneous treatment effects. American Economic Review, v. 110, n. 9, p. 2964-96, 2020.

GOODMAN-BACON, Andrew. Difference-in-differences with variation in treatment timing. Journal of Econometrics, v. 225, n. 2, p. 254-277, 2021.

IMAI, Kosuke; KIM, In Song. On the use of two-way fixed effects regression models for causal inference with panel data. Political Analysis, v. 29, n. 3, p. 405-415, 2021.

SUN, Liyang; ABRAHAM, Sarah. Estimating dynamic treatment effects in event studies with heterogeneous treatment effects. Journal of Econometrics, v. 225, n. 2, p. 175-199, 2021.
